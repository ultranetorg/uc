using System.Net;
using System.Reflection;
using System.Text.Json;
using System.Text.RegularExpressions;
using DnsClient;
using RocksDbSharp;

namespace Uccs.Rdn
{
	public enum RdnPeerCallClass : byte
	{
		None = 0, 
		Domain = McvPeerCallClass._Last + 1, 
		RdnMembers,
		QueryResource, Resource, DeclareRelease, LocateRelease, FileInfo, DownloadRelease, Cost
	}

	public abstract class RdnZone : McvZone
	{
		public override	string					Name => "Rdn" + Scope.ToString();
		public override ushort					BasePort => 020;
 		
		public bool								Auctions				= false;
		public Money							DomainRankCheckEUFee	= 5;

 		public static readonly RdnZone			Local = new RdnLocalZone();
 		public static readonly RdnZone			Test = new RdnTestZone();
 		public static readonly RdnZone			Developer0 = new RdnDeveloper0Zone();
		public static readonly RdnZone			Main = null;
		public static readonly RdnZone[]		Official = {Local, Developer0, Test};

		public static RdnZone					ByName(string name) => Official.First(i => i.Name == name);
		public static RdnZone					ById(Guid zoneid) => Official.First(i => i.Id == zoneid);
		
		public RdnZone()
		{
		}

		public override string ToString()
		{
			return Name;
		}
	}

	public class RdnLocalZone : RdnZone
	{	
		public override	ZoneScope	Scope => ZoneScope.Local;
		
		public RdnLocalZone()
		{
			Id				= new Guid("FFFFFFFF-0000-0000-0000-000000010020");
			Genesis			= "000001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000844D31DECF5DFF623300F3B4541B1CEF30C3BEEFD3C4ACA09DF4FC1F20A1E88500FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000000000000000000000000000000000000000000000000000001000000FFFFFFFF0FFFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000B7D781F9FC61CCC2274DCE908E22C068A3949EAFD7D994DA3F4FDD7DFA78CE1A0000000100000000000000000000000000000000000001030000A5A0591B2BF5085C0DDA2C39C5E478300C680B0000004A480114169545080B000000A1EDCCCE1BC2D300090000A0DEC5ADC935360000010001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000014719499527982B655955B9D55FDA680FC4DC2740D14FA5FDB6969DA530C147E00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000000000000000000000000000000000000000000000000000000010000000100020001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000041C39C663FADAD6B66B42EF8774C27A35C2321266AAB104645F540D7070CD49500FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000000000000000000000000000000000000000000000000000000000030001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000FB1D4CF86A12D2A72E1FE722CE8340CA8C3C00235B1E784385F45088F5BCC80C00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000000000000000000000000000000000000000000000000000000000040001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000A32F747489AD7D82DC2CDDBA8A267A3B9CA8A044E61A71BD70AFBE0FE011EB4600FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000000000000000000000000000000000000000000000000000000000050001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000AE24242A8E295B74F1902DD8711725DFAD4C4EDCCB8E079FFB0DEA17F452DF3700FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000000000000000000000000000000000000000000000000000000000060001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000B52E26E6A45B43850F52F0145D62FD51A7218AA362B2A0BE0AB954B5B18208DF00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000000000000000000000000000000000000000000000000000000000070001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000096D48E29616302B282AB1572469DE77564E2960524CD170C91A16FA23416876200FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000000000000000000000000000000000000000000000000000000000080001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000818910F6B3ED455DA8AA40DEC5F4620697E7E95CAC44E739AEC25948FC889AED00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800003609C52F4254819B95665AC143C2120E543CC9D272891485AA18387ECADE0CA60000000000090001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000000000000000000000004EB2AD56FF314CAF7E7B237A65F4CE9090AD599F4CBE8CB44A1980547C3D072300FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000BCC5C9E254A64319CABDA2B8F29D82DBCDBC10926DF9742636DEB9872CB6E1FF00000000000A0001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000070C3291FB85410363AACE766B00422BF118563B9A7F0B1C92177D5ADBA2DF82500FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000983ADA423071FA4C1698A114B58666415A885AEDFC590E128B8049827B628724000001000000FFFFFFFF0F0000A5A0591B2BF5085C0DDA2C39C5E478300C68000000000000000000000000D26BFED420922AF7C173CD7B2D9FBE30FD8546BF6EBDC2164196C3014275389900000A0100000000000000000000000000000000000001010100017F000064017F00006400000B0001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000000000000000000000004ABDF6753CD7406EBFA7AF0FD4E17CB628E0094084FEF9B6273A7D0BC343853E00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000009D395233BD9B1DD70116D2A1ACE88C0626DFC1B20941EA1155A93DEAA5B532D00000000000C0001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000FB8FE8E5AF19651C0B6321BD2C438801B46351D538CC67A8C36C6DC2169E55A200FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000B69F0DFF490F3C56A0BD7DF2F4BC5D6143E9D374D3BD54A0333B4B7E8953BF8000000000000D0001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000CF98E0C001AA48DE04291E978D48FD03409C95997233F7680FB8CB160AEB0DB400FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000CC4513AEA53F9BBFC59E7A734C54422AEFC1AF724DB0C746A3AE2D631698CBAE00000000000E0001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000830EA4F26BE09282903FF9706069ACD2272A9403D61349CA121A7D6B55EA066000FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800001F27EBCA25BA87BE87CF295167EE343C3534D9D9BB12234249D67D1CF811AC5300000000000F0001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000777683DA8EE53F96AD4D5B70A0C0587724EBA95EAAEAB1D6FA41E34DF7A643D100FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000E4EAAFE1E48910A82673F2EE75FC258EECF1EE945411533E66E1FA3D0CFB9DF00000000000100001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000088C4E6DF261B585DAAE8ED38339EA729B1BAFB46C62697517B69F8910AC2A7E100FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000C2D33665AEBFA30F70FF8D139915D7B0804F90E7C120665E0B6CC950933D99830000000000110001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000000000000000000000004A2BDEB1B8EDC251CFA81F445669DAA0A9A6BFC919F57AAFB98C640FDC61169300FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000024715497BFE214F403CA42F860B86BE1C595E2A1764D14DDC84E8D8DB27FDF200000000000120001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000022FC16ACE72DC1038FA7246464614A1CEACA4A97EF66930715F51E251F57929A00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000353124B2032F53BE3E8DC69BB0AAF8DBCCB39FF85E26B7FFFEFC1C9904A4A7550000000000130001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000036CE6C48C705271FA2356D8FAC0F89AEC14D7CBC3FF18DEA013947602DAC289C00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800007AC7BE2FAB336816CD893C1A5FEB8A7510F4E234AFA6216EF4BD2D3F97F026DF0000000000140001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000EC950BCE68AD49E17CF097068B1B1FF43EF33C055DDB35929F8817B575E1D26700FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000692A26994AE9D362AA420348DAB85DA0BD2902FF5B5AE2F577D621720150646E0000000000150001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000321D757B204C867AB1F726081F9389678666BAFAB4DA6C2E62D5482E10F7A2EE00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000880B33B7714B464E0900221BBF889AC7710D8869FCFBB7AE30D98101100019650000000000160001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000FC2A81ED8F377292146E119E5D4DACC358C596A285F50163424C2CE34EDA5E3900FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000081B0ED825B6DB72F3BD2A852BB9417CF87ED5F0D21DE120189919078222EFEF90000000000170001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000000000000000000000006D035D33AA83601E2002D8FDC7C4A9681D5AB6CE8D0526A5382E24E5EF925E8D00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800004216195593F4BE541BAB25B72DD3C74579DC050DF72AEE46282AD6F6A24374ED0000000000180001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000290A7DD870924DB78F0C83A1E670BEAE424C800F727323DC984A432A779065FF00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000406737F66E0CC239A810FE69124B3C1253B070DB6973232024DED04D9CC9F850000000000190001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB60800000000000000000000000098883D13134151DE52CE02E136363E4E2491127848AC1DD9AACAC4FD060D8C4A00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000839FB30C489E2E03EAB29ACDCD0ED66A50D09E2F4AC26087163021B9A2F3753C00000000001A0001FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB608000000000000000000000000CF7B38D8B45E1BE2C9A725584B67B0B7864A3A4A62C51C6232967259EC28237B00FFFF9F9D0914ED338CB26CE8B1B9B8810BAFB6080000FFEF35545A0D64EFB00038BF5DCDFBB361962F446192A381B7106A36885C8B470000000000";
			Father0IP		= new IPAddress(new byte[] {127, 0, 0, 100});
			Cryptography	= Cryptography.No;
			PoW				= false;
			Auctions		= true;
			CommitLength	= 100;
			BailMin			= 0.000_000_001;

			Initials		= Enumerable.Range(100, 16).Select(i => new IPAddress(new byte[] {127, 0, 0, (byte)i})).ToArray();
		}
	}

	public class RdnDeveloper0Zone : RdnZone
	{
		public override	ZoneScope	Scope => ZoneScope.Developer0;
	
		public RdnDeveloper0Zone()
		{
			Id		= new Guid("FFFFFFFF-0000-0000-0000-000000020020");
 			Genesis	= "00000156B2E0FE02724CB15F00C053B3FA63379DBBFB7C24C8B04912544CFDAA70535973898CE0CEDC5C8C1FFEE366DBDCAEC27DCF947A97C0CFF0CC4E95CDEA971D2A1BFFFF50E1605B6F302850694291EB0E688EF1567700000000000000000000000000000000000000000000000000000000000000000000000001000000FFFFFFFF0F31AB5B2E698E3BAFE961562F89710BD2A55F94E1F490EF3A77BCD389FCE406F535C6835B397825C0BBE12B1BAA8847035095D3963BD53DACD24E08B5E9218E751B0000070080C6A47E8D03000000000000000000000000000000000001020B000000A1EDCCCE1BC2D300000000010001ECE2EA2C50BBF6E8CC8D2352FA995EEB85CD06D463101EC3632CD9BD01C382B5674D77EB1732C16A8AF957E0A692DEA4419358C755F42970FDDA1765A6B3E91D1CFFFF50E1605B6F302850694291EB0E688EF1567700000000000000000000000000000000000000000000000000000000000000000000000000010000000100020001D4AC81ECE27AE00E0B901DE7DD8371602E8D8B3897F8BE48E25FF25A165E557214158BE4333B6419B8B4DF8CC98019933CFCBE119D272CF556431AC67A317A631BFFFF50E1605B6F302850694291EB0E688EF156770000000000000000000000000000000000000000000000000000000000000000000000000000000300015FE97DC54F2F18B1BB91CB151BE3BB8901E013230344FF740B2FD363DCBBCB82650806CBE15DB2848D58C39166DD725A03A520CFAE315B7CE01A576C2BD092041CFFFF50E1605B6F302850694291EB0E688EF156770000000000000000000000000000000000000000000000000000000000000000000000000000000400014E9AA0D00850FF0B12C517D7E30312AAF406F66D247BE72DA8C7C194E1E260A2195AADD8DD320FCFF518E73B3712E56A0F5F2F161437E2A13010F9F4CA45FA0F1CFFFF50E1605B6F302850694291EB0E688EF15677000000000000000000000000000000000000000000000000000000000000000000000000000000050001AEA29D3C2F2DAA35F60E6A9CEA237A92F04A5BEB6D067A8C389C19E6AF6567AB217EEEB8EF0789C33D22255D8030C8215388532ACA0CAA4C52B68504CE867C401CFFFF50E1605B6F302850694291EB0E688EF15677000000000000000000000000000000000000000000000000000000000000000000000000000000060001F90B95F797AA3BB20498B7557B735E80B63CAABB8EB700808F1B02CA88D9A92276897EF47BE8CE25339158CAFB2E5D56D48A512D92E88482D37E4068720766501BFFFF50E1605B6F302850694291EB0E688EF15677000000000000000000000000000000000000000000000000000000000000000000000000000000070001393C03D44A0E1CCEC046B96181374958CFC40DD4C3FECBA5C6F6F1AA19392CD24A0ABE2DDCE63AA51457E588EF380DE9FE320CCD9E6CB06521AE0343702F0F531CFFFF50E1605B6F302850694291EB0E688EF15677000000000000000000000000000000000000000000000000000000000000000000000000000000080001AAD4E8A3A4CFCD18C4B788FF1821A7F803E9F53BC7C7CA689DB24B48AEB318CA0FC6DF596B627061E38D06AB4987A26BFA54E421E2CE630D74BDA849F878AEE81BFFFF50E1605B6F302850694291EB0E688EF156770000E9C055849F5E214DCDB8A614BCDA66E8B6F732ABA65D3D8E214D1377A33A75B1000000000009000112768B0AF84AB70DB122E32E2814B4F219A5CD0C139B36E4C910BBC9A8FB915671E2A6237F85F68C22650981C0062C4275B194091FEA7C3BD41524DD9F09694C1BFFFF50E1605B6F302850694291EB0E688EF156770000970A2ED0A94B41B690A08D4C649D12428648BD6E6A504605EC40A8310FB9482000000000000A00016758448BB72133739DF87E40D067F1A1BE139CA44E2884688A088131C03DD5603129BCA86DD2C314C07C6E79DBE7694DADAE305E687FD7D218A06436CFFF3FB71CFFFF50E1605B6F302850694291EB0E688EF1567700001BA653967FAE04543FD351244589DBE63339E090A723C7E499399342667E09EA000001000000FFFFFFFF0FB8982C1010A03FEA50D2BEF4CC3E75EBF8C3007A92485489037B980D465F0DF82345344504EC8DA521FA8A70DA5E91CA50FC13A8BC66040D7C202B0CBCFC3A0F1C010A070080C6A47E8D03000000000000000000000000000000000001010B000000A1EDCCCE1BC2D300014E2FCC64014E2FCC6400000B0001CB95E931FA3C6008FC169D95F638C36CFFA736DDE9D4249A9C589782286C120E28243B0C8C2AC88EFA1098125344A5CEE2C3A6FD01849B927FE92D6E68FEC9921CFFFF50E1605B6F302850694291EB0E688EF1567700002536A6D2848A8D3096FCD5E24C9D4B615D0B094D1872CD293B30F87A95C4CE8000000000000C0001C213A94C4CA6328C46BA148020D1443EEE746DFAA2CC82BFE36A7C074734F93043C37BD93CA8149CF481DB00C413ECCD6E1C17E7CC64859D3BD4E3265CED49E91CFFFF50E1605B6F302850694291EB0E688EF156770000D24F54D0582478C605B37737BC7A2B24B5A511A7D11420E5DE4DFAF9B68DF9D700000000000D0001B00FB39B09A97BFB9D79D732BAD40D132CF3E5587AF4FAEB270BC98835DD4CA47766B3BBB18D92E76AF9CF9C33D8FA893060DB5BFA145FEBBA678B54FD4E55971CFFFF50E1605B6F302850694291EB0E688EF156770000B06BE3812B3C134B7ECF59C24E96DF77875E3E22565BAD4E4F73E3ACC3AE12B700000000000E0001E15F3C8210AC11110EBE3B5019B0C1966688D1BA71853D989690CEB4EDD248F1342705BE8A10FAD898BB60AB61D1914E5650C8B62AE91C172E4388345B62075A1CFFFF50E1605B6F302850694291EB0E688EF156770000A3C45DF26003CF8D1CBC182056999960B0214794D076307A5E5CD6E872311CF400000000000F00012333132F2B82229D5A6FE722CC6247CCFC5642FB1DF898C185CA0A9661D888B66DF5272AFBB2B17D5541030711F489254601ED1246C154B0EDEAAAF18D192C0C1CFFFF50E1605B6F302850694291EB0E688EF1567700002F9D0CBB3D050B02387DBD015DF2F4046C763CFEE435FED18661F8072411D7870000000000100001F26568735D68C33BD436DED9050384DB4B811DAA9A626768FCB2266F4EE73CAB06A9AADD765481C96DF7AFC971423252BC11577593621940AB4940C22721783B1CFFFF50E1605B6F302850694291EB0E688EF1567700003264784CC4D5B8109D85DE75B74B69368048923B90957F03B2E79ACBCFAB3232000000000011000176C20AF8BDE83242201FE23C3FE98D144BA22CAF5CA0457D1A34D2BBC941737A26985FDBDB6DDDDAF8B3E6133D428D620E66CBA3A677CA38146359726BD63BB01CFFFF50E1605B6F302850694291EB0E688EF15677000045565D0BFB78DB9DC6830B661A6DF7B2F753A0967740DE6CC76BB80E41789AD70000000000120001B6380E3189FEAF746AE1FB9676E2DB8A91F51DB5C81BDACF248F61AAB62E667E0D120E210C6215418CB2A4B388B5C1FEA44DF63EC5A0D3E2A64141878B90BC241BFFFF50E1605B6F302850694291EB0E688EF156770000A077E4882482B048DBB82B2BEF631FC37AB236C34CA4C8A28B0D8CF56B8C773A0000000000130001869F5400C9BBCEFCDE0210FC8631AA5526F15C84EC34CB1B3695A80EB0FDAC316C7FB2072CF98212F004F70F6F9E8F8ED28E8405C89D1A9742BC9054326F143F1CFFFF50E1605B6F302850694291EB0E688EF1567700005A9FC1853201278331A83FBFFF34261968A280531CDEAE135CCF8A2F3AF04B990000000000140001BE71812FA4DED5F79171BD5D39FB99BECEDCF1E1124ADF15D786175016956AC9630A5F381BCBD8727C965028AA2E17D804FA6D441E4FABB1A0DA813D5B1FF7E51BFFFF50E1605B6F302850694291EB0E688EF156770000BF3BB214A6CCBAD3A6C95D6367E0F6749FEEF50B021B60CA49867921B7D2308B00000000001500015A2F5D59F50E9A274FCC4BCAD61B0A9ED036D26FA65AE088DCB3331F06E0730802D730012CB5B1F586EB94D52458C0314211E31223CC9E464BB0704E66DF4AB41CFFFF50E1605B6F302850694291EB0E688EF156770000B1CE6576B5FEE9DFE250CA9617AE4DC3965D3A85CDF77A38312EFC31E111ED2A000000000016000171AD72C9403A2051C72BC30F6B5F9EC7FFE0C4AD7F3850A462D9FC1CF10A63726E8C14060AED85DAD11198F1DB4994E20AAB8D5CDCD419847B1ECB1F8D6D67D81BFFFF50E1605B6F302850694291EB0E688EF1567700009976F3E94E2161ECF9555AA652467069A5B82F686991DAEA6F3B2A56C29B9AC20000000000170001F8D63C45A25D7EFBF018EBD35AE3F3B9D5C7B0587E71D3BFA56FB2E2374BAF910C47B300F982EED481AB09287D522A9AD8C22BF341041853142F841EF65273291BFFFF50E1605B6F302850694291EB0E688EF15677000023CCEB86591E8552EC2FF0D0B25D2C18C259780D546C690432C4EBAFEC4AE3910000000000180001C19F2F6BD9C6848C57A4B0CFE97C1E9003E2325A1D5178CEDA58A0EB5A852206565EB0C2D741516854ACF1E2182008BEFDA38561957864875DE1A8FE7D55234A1CFFFF50E1605B6F302850694291EB0E688EF156770000D33B99B690EB3101AD2AAD21031229E5EDE401B500925D05949785C2FDE030B60000000000190001AA0C0E9AF368FBF1D050534FC0C0FDE9C6B00572CEFFD5A8523C138AE5A12A6F16194F5172331D0F6CEBAC46C7670DEB422178E00FBF5C07FB3937A173B6FE921CFFFF50E1605B6F302850694291EB0E688EF156770000F30D2F1468C340577F8C894165B10AB92D5C13755200893E6B180AD49745861000000000001A0001655944D488D04C79C5D8EF96762B1B4BC08AFC7A1AE959FCD27860A9189423F47D230D3E467F9295982CBC06C80550F05A66756CA647F23F195AC5498E98EBF71CFFFF50E1605B6F302850694291EB0E688EF1567700004D9574B26CD4E084B3EE05BF8E2196769ED78449ED066B1F4856DDEDA0793C790000000000";
			
			var z = Test;

 			Father0IP	= z.Father0IP;
			Initials	= z.Initials;
		}
	}

	public class RdnTestZone : RdnZone
	{
		public override	ZoneScope	Scope => ZoneScope.PublicTest;
	
		public RdnTestZone()
		{
			Id			= new Guid("00000000-0000-0000-0000-000000030020");
 			Genesis		= "0000016190B7B9EA8FD4C94C07095FD591197BF163508E3CF548AA3AD2CE515CDF54896FC3C626B991493D49D8B3F5B4826F6CF342A0BD233AFFA0A9AFCECBDB98281E1BFFFF50E1605B6F302850694291EB0E688EF15677000000000000000000000000000000000000000000000000000000000000000000000001000038A7A3CB80EC769C632B7B3E43525547ECD10000000001000000FFFFFFFF0F295D2BE985CD50F2EF341B928425C0CBFDF97B66124B919BE5B5944592D14FDB3B2B1A7501155A4C22E8C036F9807F7B67AC0D72D90733A5C3E8681F0ACB59961C0000070080C6A47E8D03000000000000000000000000000000000001020B000000A1EDCCCE1BC2D300000100011C7E31EEC17725D06E360B3D5CCC283AABC98C1663EC11ADD02F5E314CEDFD9148F8350AE4389B7630C16FB01880EE1FF42EEF364334E9810216448A07F7EA511CFFFF50E1605B6F302850694291EB0E688EF1567700000000000000000000000000000000000000000000000000000000000000000000000000000100000001000002000105255A46763F2675E7A4DA932816C3949B1F04A37F4E92F1D8AF76BF5BE8BC12125283DDA56FC5ACF77874F32BA20C8CB1D5D7AAD89ED32DFD113D065751F1461CFFFF50E1605B6F302850694291EB0E688EF156770000000000000000000000000000000000000000000000000000000000000000000000000000000000030001B095FF9BD40D745F621C96C8FA5E43EA09F823E8959C70DCBD2726AF84FE332B56A5E6AA84925A184631DA76F1F5E8988D5F2E0A47CAAB5A462268B6F1AD34D41CFFFF50E1605B6F302850694291EB0E688EF15677000000000000000000000000000000000000000000000000000000000000000000000000000000000004000165E5779EFD503CEDD3DA4F1E78214689B0A8754A2315AE5C1A633F64025504C13694A90713E80086D6BACA2854F66E6AE8ACF23F059491A8EAA1A1320AAD2D301BFFFF50E1605B6F302850694291EB0E688EF1567700000000000000000000000000000000000000000000000000000000000000000000000000000000000500010E3D0F53E2C2A2A319C49566F7B6A59FB98A21640D21881B8A25CC25F879B24F4BD0516727245E0C352F8AE0DE44CC157D8ABE7E5285231AB2C396114EF4F0001BFFFF50E1605B6F302850694291EB0E688EF1567700000000000000000000000000000000000000000000000000000000000000000000000000000000000600010122DB71D12EDF439A1B4053427DE539E01BE474CBED8EDBC41216A6BB28DF73548DF3DFB0D2E27C5F32FDC92DCE78E2CFB9C42AAABA29C71A27A7D51CAC54F91CFFFF50E1605B6F302850694291EB0E688EF156770000000000000000000000000000000000000000000000000000000000000000000000000000000000070001E19C721D8E4B0E6337F3FE79FE795BB313D7E839B5F45BA10209865A2D1432BC6D02867FFCB51D53E9BA8283E2893B83A622F3EEB2F3104847BEEAA7D410B5371BFFFF50E1605B6F302850694291EB0E688EF15677000000000000000000000000000000000000000000000000000000000000000000000000000000000008000190450155EA78006F98E301541179F8C6449E0B451C507D25286EBF8A79A99594148A8189D66F98BF7817B2EAC9D28ACDBE262979D3634074BD955F1BFD2F0EE61BFFFF50E1605B6F302850694291EB0E688EF156770000E9C055849F5E214DCDB8A614BCDA66E8B6F732ABA65D3D8E214D1377A33A75B100000000000000090001658B84646736BDCB493079CC2BBC60A6F4C2D762A295E00E657CEECED22304852A52270B54B6822C2203BDFFD6AFA0E6DAB046BCD9BF073060BA42E107977E5E1BFFFF50E1605B6F302850694291EB0E688EF156770000970A2ED0A94B41B690A08D4C649D12428648BD6E6A504605EC40A8310FB94820000000000000000A0001774C132691EC96207E98D2219C6371BE09D28803F5F4BBA2244707FF940E5E916534A95E1D3A17A6111026D1D8AC1E4C914F35672C456D3989BC62967AEC5C6A1CFFFF50E1605B6F302850694291EB0E688EF1567700001BA653967FAE04543FD351244589DBE63339E090A723C7E499399342667E09EA00000000000001000000FFFFFFFF0F41CA1A151064A87A606E02D2B10C47DF97D8F77ED3EDC895C878980F38ED4A7E2150310C063832A77CF26A11544FFC20A07249C753B1CC0B8970C49133AF87BF1B010A070080C6A47E8D03000000000000000000000000000000000001010B000000A1EDCCCE1BC2D300014E2FCC64014E2FCC640B0001B9A71AFC6122B8DE6C174FB0EA5BEAF3CA7253BE51C650CF947680E93CE23B9D23212D3E951C402D437774F217E7712E60CF032B7E611D91C3AB75AE60696E051CFFFF50E1605B6F302850694291EB0E688EF1567700002536A6D2848A8D3096FCD5E24C9D4B615D0B094D1872CD293B30F87A95C4CE80000000000000000C0001A4CA885A116CEF7FDB868BB6587C6D7011752118D8ED9308A06628F8BB32E417211C15A9AF49FE7F4C91673A16B849848B5C4A169ECBB2ACB65CC5C974E3D3031BFFFF50E1605B6F302850694291EB0E688EF156770000D24F54D0582478C605B37737BC7A2B24B5A511A7D11420E5DE4DFAF9B68DF9D7000000000000000D0001CA9D8D1DA8575AE0767A4EAC794FB2502B496BDF260C1CC03F934B34017624256671F49A1F5209515F46E6B0EDAC99569EDF6E993798C967E483988C24F082871BFFFF50E1605B6F302850694291EB0E688EF156770000B06BE3812B3C134B7ECF59C24E96DF77875E3E22565BAD4E4F73E3ACC3AE12B7000000000000000E0001E1F9A4E5F024CB5A483DBC3E6E83524E7365D5362613820F7DE94BC391A1E9A11613D222F03DEA23CDF6F606F2E438A3523D81B9D6C69A7CD01E7965CFE0F2431CFFFF50E1605B6F302850694291EB0E688EF156770000A3C45DF26003CF8D1CBC182056999960B0214794D076307A5E5CD6E872311CF4000000000000000F000178039D05728310E6000FBE973E1051B4F5D4065E841B1266B7EC72F3D434F51D75DF6A7AFDB20240361AB247F7FBDC0C5EB189358E3990D43A1AF27D992BBC5D1BFFFF50E1605B6F302850694291EB0E688EF1567700002F9D0CBB3D050B02387DBD015DF2F4046C763CFEE435FED18661F8072411D787000000000000001000015249A7B4095AAF7390E76C832DBA079A591FE09A9B846A53B61E2E2975C963A453E4167DB1A4B3B8FE6026E722FE4F15BE27BEF028B3925B8A0826556D6303061BFFFF50E1605B6F302850694291EB0E688EF1567700003264784CC4D5B8109D85DE75B74B69368048923B90957F03B2E79ACBCFAB3232000000000000001100011E91DC1BBDAB6E1749FA2B25AFC3B45EA2B25675257A80810A3CC4D78DB19CBF612F1313B83879248C352C60FAB7F359A1F3B10653D14E6F8C28D3DF3C8E047B1BFFFF50E1605B6F302850694291EB0E688EF15677000045565D0BFB78DB9DC6830B661A6DF7B2F753A0967740DE6CC76BB80E41789AD7000000000000001200018251D9ED0609DCF7CC69B4A7152228951272525CEE5C3525F097E2B6E3A60E6301049D02834CC6375BB3226547121230D454EB74910FE746383F302EDA9348791CFFFF50E1605B6F302850694291EB0E688EF156770000A077E4882482B048DBB82B2BEF631FC37AB236C34CA4C8A28B0D8CF56B8C773A00000000000000130001EB8D81A001EB7F93CEEF0000A05AACC5A03281C8A49F8467D5A15A3E6B547552373D48D992F9B5B43F22F519F72333E8EBE429460BB788F3FA1ADEF9D8DC848B1BFFFF50E1605B6F302850694291EB0E688EF1567700005A9FC1853201278331A83FBFFF34261968A280531CDEAE135CCF8A2F3AF04B9900000000000000140001AD672F6D0C001E003B9C0BE7B13C8F8875D05EC09D3CC5248E727E5D83968C6665ADBAB249C8E6993BBEC6102E240C4C8E041989F5E1ADFBCBF633AA017949AB1BFFFF50E1605B6F302850694291EB0E688EF156770000BF3BB214A6CCBAD3A6C95D6367E0F6749FEEF50B021B60CA49867921B7D2308B00000000000000150001EA48BC8A98DFF2960BDE44EA5E9B6E53DB2D4420936B08F2FC9B3A8ABAC1897E0BB46324016CA6319987CD1D4CE74AD9FBFEB3376AAF5B94B0BADF3F1B7A93DE1BFFFF50E1605B6F302850694291EB0E688EF156770000B1CE6576B5FEE9DFE250CA9617AE4DC3965D3A85CDF77A38312EFC31E111ED2A0000000000000016000138D4F79F994348128F2AAA0DA665F27BCC6FB0941C5D36769E6517EE6F7CDEEB7C3049D2499D812A5BEA330658912D4ADD6D86D589F4E1370EB2F27533FEEBA01CFFFF50E1605B6F302850694291EB0E688EF1567700009976F3E94E2161ECF9555AA652467069A5B82F686991DAEA6F3B2A56C29B9AC200000000000000170001354C9A2CE0FA078F3D3B4F28A9EEA98CC14441732B1802E19C8171F61C7E0FF93B30C4E34B0EF0C7069F6C1E05C6FC97FC998E31B51FC76085BB0F4D03F0472B1CFFFF50E1605B6F302850694291EB0E688EF15677000023CCEB86591E8552EC2FF0D0B25D2C18C259780D546C690432C4EBAFEC4AE39100000000000000180001DC34E55247E8A059C6F33150A70047AF8152D10C28FDFFBABDE5B5CB526ED85A32D77CA84A0103B4D12E394B3B757A5E3CB2290E1080BA09DCE2BEBD98DD298A1CFFFF50E1605B6F302850694291EB0E688EF156770000D33B99B690EB3101AD2AAD21031229E5EDE401B500925D05949785C2FDE030B60000000000000019000138EE2D0EBE8C83AF2ED0FFDA8F8E344933C76A7A519C9FA21F69144FBACBDECC10853053A38A3569CE7A0EF1B1A3F8EC409B066246E939B963F7C3EC84DC4AEA1BFFFF50E1605B6F302850694291EB0E688EF156770000F30D2F1468C340577F8C894165B10AB92D5C13755200893E6B180AD497458610000000000000001A0001FF8FB18287781A2BED066C243540C6133D092F5833834B996F1B9939841BE4CB0C234294CB4A34E9926307B496542DE63D8036590DCD14ECCD5CFB37C662CA071BFFFF50E1605B6F302850694291EB0E688EF1567700004D9574B26CD4E084B3EE05BF8E2196769ED78449ED066B1F4856DDEDA0793C7900000000000000";
 			Father0IP	= IPAddress.Parse("78.47.204.100");
			Initials	= UOInitials;
		}
	}

	public class RdnNode : McvNode
	{
		public override long					Roles => Mcv == null ? 0 : Mcv.Settings.Roles;
		public new RdnZone						Zone => base.Zone as RdnZone;
		public new RdnMcv						Mcv => base.Mcv as RdnMcv;
		public new RdnSettings					Settings => base.Settings as RdnSettings;

		LookupClient							Dns = new LookupClient(new LookupClientOptions {Timeout = TimeSpan.FromSeconds(5)});
		HttpClient								Http = new HttpClient();

		public ResourceHub						ResourceHub;
		public PackageHub						PackageHub;
		public SeedHub							SeedHub;


		public RdnNode(string name, Guid zoneid, string profile, RdnSettings settings, Vault vault, IClock clock, Flow flow) : base(name, RdnZone.ById(zoneid), settings ?? new RdnSettings(Path.Join(profile, zoneid.ToString())), vault, flow)
		{
			Flow.Log?.Report(this, $"Zone: {Zone.Name}");
		
			if(Settings.Api != null)
			{
				ApiServer = new RdnApiServer(this, Flow);
			}

			if(Settings.Seed != null)
			{
				ResourceHub = new ResourceHub(this, Zone, Settings.Seed);
				PackageHub = new PackageHub(this, Settings.Seed);
			}

			if(Settings.Base != null)
			{
				base.Mcv = new RdnMcv(	this, 
										Settings,
										Path.Join(Settings.Profile, "Mcv"),
										flow,
										clock ?? new RealClock());

				Mcv.Commited += r => {
										if(Mcv.LastConfirmedRound.Members.Any(i => Settings.Generators.Contains(i.Account)))
										{
											var ops = r.ConsensusTransactions.SelectMany(t => t.Operations).ToArray();
													
											foreach(var o in ops)
											{
												if(o is DomainMigration am)
												{
		 											if(!NodeGlobals.SkipMigrationVerification)
		 											{
														Task.Run(() =>	{
																			var approved = IsDnsValid(am);
	
																			lock(Lock)
																				Mcv.ApprovedMigrations.Add(new ForeignResult {OperationId = am.Id, Approved = approved});
																		});
		 											}
													else
														Mcv.ApprovedMigrations.Add(new ForeignResult {OperationId = am.Id, Approved = true});
												}
		
												#if ETHEREUM
												if(o is Immission e)
												{
													Task.Run(() =>	{
																		var v = Ethereum.IsEmissionValid(e);
	
																		lock(Lock)
																			Mcv.ApprovedEmissions.Add(new ForeignResult {OperationId = e.Id, Approved = v});
																	});
												}
												#endif
											}
										}
	
										Mcv.ApprovedEmissions.RemoveAll(i => (r as RdnRound).ConsensusEmissions.Any(j => j.OperationId == i.OperationId) || r.Id > i.OperationId.Ri + Zone.ExternalVerificationRoundDurationLimit);
										Mcv.ApprovedMigrations.RemoveAll(i => (r as RdnRound).ConsensusMigrations.Any(j => j.OperationId == i.OperationId) || r.Id > i.OperationId.Ri + Zone.ExternalVerificationRoundDurationLimit);
									};

				if(Settings.Generators.Any())
				{
					#if ETHEREUM
		  			try
		  			{
		 				new Uri(Settings.Ethereum.Provider);
		  			}
		  			catch(Exception)
		  			{
		  				Ethereum.ReportEthereumJsonAPIWarning($"Ethereum Json-API provider required to run the node as a generator.", true);
						return;
		  			}
					#endif

					SeedHub = new SeedHub(Mcv);
				}
			}

			RunPeer();

		}

		static RdnNode()
		{
			foreach(var i in Assembly.GetExecutingAssembly().DefinedTypes.Where(i => i.IsSubclassOf(typeof(PeerRequest)) && !i.IsGenericType))
			{	
				var c = Enum.Parse<RdnPeerCallClass>(i.Name.Remove(i.Name.IndexOf("Request")));
				
				ITypeCode.Codes[i] = (byte)c;
				ITypeCode.Contructors[typeof(PeerRequest)][(byte)c]  = i.GetConstructor([]);
			}

			foreach(var i in Assembly.GetExecutingAssembly().DefinedTypes.Where(i => i.IsSubclassOf(typeof(PeerResponse))))
			{	
				var c = Enum.Parse<RdnPeerCallClass>(i.Name.Remove(i.Name.IndexOf("Response")));

				ITypeCode.Codes[i] = (byte)c;
				ITypeCode.Contructors[typeof(PeerResponse)][(byte)c]  = i.GetConstructor([]);
			}

			ITypeCode.Contructors[typeof(Urr)] = [];

			foreach(var i in Assembly.GetExecutingAssembly().DefinedTypes.Where(i => i.IsSubclassOf(typeof(Urr)) && !i.IsAbstract))
			{
				ITypeCode.Codes[i] = (byte)Enum.Parse<UrrScheme>(i.Name);
				ITypeCode.Contructors[typeof(Urr)][(byte)Enum.Parse<UrrScheme>(i.Name)] = i.GetConstructor([]);
			}
		}

		public override string ToString()
		{
			return string.Join(", ", new string[]{	Name,
													(Settings.Api != null ? "A" : null) +
													(Settings.Base != null ? "B" : null) +
													(Settings.Base?.Chain != null  ? "C" : null) +
													(Settings is RdnSettings x && x.Seed != null  ? "S" : null),
													Connections.Count() < Settings.Peering.PermanentMin ? "Low Peers" : null,
													Mcv != null ? $"{Synchronization}/{Mcv.LastConfirmedRound?.Id}/{Mcv.LastConfirmedRound?.Hash.ToHexPrefix()}" : null,
													$"T(i/o)={IncomingTransactions.Count}/{OutgoingTransactions.Count}"}
						.Where(i => !string.IsNullOrWhiteSpace(i)));
		}

		protected override void CreateTables(ColumnFamilies columns)
		{
			columns.Add(new (ResourceHub.ReleaseFamilyName,	new ()));
			columns.Add(new (ResourceHub.ResourceFamilyName,new ()));
		}

		public override void RunPeer()
		{
			base.RunPeer();

			if(Settings.Seed != null)
			{
				ResourceHub.RunDeclaring();
			}
		}

		public override object Constract(Type t, byte b)
		{
			if(t == typeof(Manifest))		return new Manifest();

			return base.Constract(t, b);
		}

		private bool IsDnsValid(DomainMigration am)
		{
			try
			{
				var result = Dns.QueryAsync(am.Name + '.' + am.Tld, QueryType.TXT, QueryClass.IN, Flow.Cancellation);

				var txt = result.Result.Answers.TxtRecords().FirstOrDefault(r => r.DomainName == am.Name + '.' + am.Tld + '.');

				if(txt != null && txt.Text.Any(i => Regex.Match(i, "0[xX][0-9a-fA-F]{40}").Success && AccountAddress.Parse(i) == am.Transaction.Signer))
				{
					return true;
				}

				if(am.RankCheck)
				{
					using(var m = new HttpRequestMessage(HttpMethod.Get, $"https://www.googleapis.com/customsearch/v1?key={Mcv.Settings.GoogleApiKey}&cx={Mcv.Settings.GoogleSearchEngineID}&q={am.Name}&start=10"))
					{
						var cr = Http.Send(m, Flow.Cancellation);

						if(cr.StatusCode == HttpStatusCode.OK)
						{
							JsonElement j = JsonSerializer.Deserialize<dynamic>(cr.Content.ReadAsStringAsync().Result);

							var domains = j.GetProperty("items").EnumerateArray().Select(i => new Uri(i.GetProperty("link").GetString()).Host.Split('.').TakeLast(2));

							return domains.FirstOrDefault(i => i.First() == am.Name)?.Last() == am.Tld;
						}
					}
				}
			}
			catch(Exception)
			{
			}

			return false;
		}

		public override bool ProcessIncomingOperation(Operation o)
		{
			#if ETHEREUM
			if(o is Immission e && !Ethereum.IsEmissionValid(e))
				return false;
			#endif

			if(o is DomainMigration m && !IsDnsValid(m))
				return false;

			return true;
		}

		public override void OnRequestException(Peer peer, NodeException ex)
		{
			base.OnRequestException(peer, ex);

			if(ex.Error == NodeError.NotSeed)	peer.Roles  &= ~(long)RdnRole.Seed;
		}

	}
}
