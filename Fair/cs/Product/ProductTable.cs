namespace Uccs.Fair;

public class ProductTable : Table<ProductEntry>
{
	public IEnumerable<FairRound>	Tail => Mcv.Tail.Cast<FairRound>();
	public new FairMcv				Mcv => base.Mcv as FairMcv;

	public ProductTable(FairMcv rds) : base(rds)
	{
		List<ProductEntry> load(string t)
		{
			var s = new MemoryStream(t.FromHex());
			var r = new BinaryReader(s);
	
			var _NextEntryId = r.Read7BitEncodedInt();

			return r.ReadList(()=>	{ 
										var e = Create();
										e.ReadMain(r);
										return e;
									});
			
		}
		
		var _100 = load("3434818004008180040000A21701055469746C6502000F546865204170706C69636174696F6E0101125468652052656A6563746564205469746C650001818204008180040181800400000000018182040181800402818004000000000181820402818004038180040000000001818204038180040481800400000000018182040481800405818004000000000181820405818004068180040000000001818204068180040781800400000000018182040781800408818004000000000181820408818004098180040000000001818204098180040A81800400000000018182040A8180040B81800400000000018182040B8180040C81800400000000018182040C8180040D81800400000000018182040D8180040E81800400000000018182040E8180040F81800400000000018182040F818004108180040000000001818204108180041181800400000000018182041181800412818004000000000181820412818004138180040000000001818204138180041481800400000000018182041481800415818004000000000181820415818004168180040000000001818204168180041781800400000000018182041781800418818004000000000181820418818004198180040000000001818204198180041A81800400000000018182041A8180041B81800400000000018182041B8180041C81800400000000018182041C8180041D81800400000000018182041D8180041E81800400000000018182041E8180041F81800400000000018182041F818004208180040000000001818204208180042181800400000000018182042181800422818004000000000181820422818004238180040000000001818204238180042481800400000000018182042481800425818004000000000181820425818004268180040000000001818204268180042781800400000000018182042781800428818004000000000181820428818004298180040000000001818204298180042A81800400000000018182042A8180042B81800400000000018182042B8180042C81800400000000018182042C8180042D81800400000000018182042D8180042E81800400000000018182042E8180042F81800400000000018182042F81800430818004000000000181820430818004318180040000000001818204318180043281800400000000018182043281800433818004000000000181820433");
		var _102 = load("3434818004008180040000A21701055469746C6502000F546865204170706C69636174696F6E0101115468652055706461746564205469746C650001818204008180040181800400000000018182040181800402818004000000000181820402818004038180040000000001818204038180040481800400000000018182040481800405818004000000000181820405818004068180040000000001818204068180040781800400000000018182040781800408818004000000000181820408818004098180040000000001818204098180040A81800400000000018182040A8180040B81800400000000018182040B8180040C81800400000000018182040C8180040D81800400000000018182040D8180040E81800400000000018182040E8180040F81800400000000018182040F818004108180040000000001818204108180041181800400000000018182041181800412818004000000000181820412818004138180040000000001818204138180041481800400000000018182041481800415818004000000000181820415818004168180040000000001818204168180041781800400000000018182041781800418818004000000000181820418818004198180040000000001818204198180041A81800400000000018182041A8180041B81800400000000018182041B8180041C81800400000000018182041C8180041D81800400000000018182041D8180041E81800400000000018182041E8180041F81800400000000018182041F818004208180040000000001818204208180042181800400000000018182042181800422818004000000000181820422818004238180040000000001818204238180042481800400000000018182042481800425818004000000000181820425818004268180040000000001818204268180042781800400000000018182042781800428818004000000000181820428818004298180040000000001818204298180042A81800400000000018182042A8180042B81800400000000018182042B8180042C81800400000000018182042C8180042D81800400000000018182042D8180042E81800400000000018182042E8180042F81800400000000018182042F81800430818004000000000181820430818004318180040000000001818204318180043281800400000000018182043281800433818004000000000181820433");
	
		_102 = _102;
	}
	
	public override ProductEntry Create()
	{
		return new ProductEntry(Mcv);
	}

	public ProductEntry Find(EntityId id, int ridmax)
	{
		//if(0 < ridmax && ridmax < Database.Tail.Last().Id - 1)
		//	throw new IntegrityException("maxrid works inside pool only");

  		foreach(var i in Tail.Where(i => i.Id <= ridmax))
			if(i.AffectedProducts.TryGetValue(id, out var r))
    			return r;

		var e = FindBucket(id.B)?.Entries.Find(i => i.Id.E == id.E);

		//if(e == null)
		//	return null;

		//e.Address.Publisher = Mcv.Publishers.Find(id, ridmax).Address;

		return e;
	}
	
// 	public ProductEntry Find(Ura address, int ridmax)
// 	{
//  		//if(0 < ridmax && ridmax < Database.Tail.Last().Id - 1)
//  		//	throw new IntegrityException("maxrid works inside pool only");
// 
//   		foreach(var r in Tail.Where(i => i.Id <= ridmax))
//  		{	
//  			var x = r.AffectedProducts.Values.FirstOrDefault(i => i.Address == address);
//  					
//  			if(x != null)
//   				return x;
//  		}
//  
//         var d = Mcv.Publishers.Find(address.Publisher, ridmax);
// 
//         if(d == null)
//             return null;
// 
//   		var e = FindBucket(d.Id.H)?.Entries.Find(i => i.Id.E == d.Id.E && i.Address.Product == address.Product);
// 
// 		if(e == null)
// 			return null;
// 
// 		e.Address.Publisher = d.Address;
// 
// 		return e;
// 	}
 }
