using System;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Net;
using System.Numerics;
using System.Security.Cryptography;
using System.Text;
using System.Threading.Tasks;
using Nethereum.ABI.Util;
using Nethereum.BlockchainProcessing.BlockStorage.Entities;
using Nethereum.Hex.HexConvertors.Extensions;
using Nethereum.Model;
using Nethereum.RPC.Accounts;
using Nethereum.Signer;
using Nethereum.Util;
using Nethereum.Web3;
using Nethereum.Web3.Accounts;
using Org.BouncyCastle.Utilities;
using Org.BouncyCastle.Utilities.Encoders;
using RocksDbSharp;

namespace UC.Net
{
	public delegate void BlockDelegate(Block b);

	public class Database
	{
		public class ZoneGenesis
		{
			public Zone			Zone;
			public Cryptography Crypto;
			public string		Rounds;
		}

		public ZoneGenesis					Genesis => Genesises.Find(i => i.Zone == Settings.Zone && i.Crypto.GetType() == Cryptography.Current.GetType());

		public const int					Pitch = 8;
		public const int					LastGenesisRound = Pitch * 3;
		public const int					MembersMin = 7;
		public const int					MembersMax = 1024;
		public const int					NewMembersPerRoundMax = 1;
		public const int					MembersRotation = 32;
		public static int					TailLength => Settings.Dev != null && Settings.Dev.TailLength100 ? 100 : 1000;
		const int							LoadedRoundsMax = 1000;
		public static readonly Coin			BailMin = 1000;
		public static readonly Coin			FeePerByte = new Coin(0.000001);

		public Settings						Settings;
		public Role							Roles => (Settings.Database.Base ? Role.Base : 0) | (Settings.Database.Chain ? Role.Chain : 0);

		public List<Round>					Tail = new();
		public Dictionary<int, Round>		LoadedRounds = new();
		//public List<Member>					Members	= new();
		//public List<Account>				Funds = new();

		public RocksDb						Engine;
		public byte[]						BaseState;
		static readonly byte[]				BaseStateKey = new byte[] {0x01};
		//public byte[]						__BaseStateHash;
		static readonly byte[]				__BaseHashKey = new byte[] {0x02};
		public byte[]						BaseHash = Cryptography.ZeroHash;
		static readonly byte[]				ChainStateKey = new byte[] {0x03};
		static readonly byte[]				GenesisKey = new byte[] {0x04};
		public AccountTable					Accounts;
		public AuthorTable					Authors;
		public ProductTable					Products;
		public RealizationTable				Realizations;
		public ReleaseTable					Releases;
		public int							Size => BaseState == null ? 0 : (BaseState.Length + 
																			Accounts.Clusters.Sum(i => i.MainLength) +
																			Authors.Clusters.Sum(i => i.MainLength) +
																			Products.Clusters.Sum(i => i.MainLength) +
																			Realizations.Clusters.Sum(i => i.MainLength) +
																			Releases.Clusters.Sum(i => i.MainLength));
		public Log							Log;
		public BlockDelegate				BlockAdded;

		readonly static List<ZoneGenesis>	Genesises =	new()
											{
												new ZoneGenesis {Zone = Zone.Localnet, Crypto = new NoCryptography(), Rounds = "00000103ffff50e1605b6f302850694291eb0e688ef1567700000000000000000000000029290a2571d83b28d33e63b8b42eff638b605fbcb5f798c403d29f36d4b7551b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001eeee974ab6b3e9533ee99f306460cfc24adcdae000ffff50e1605b6f302850694291eb0e688ef1567741003f16df410e83b29179b85e9dd852302ecee648000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000003e225e528b2da96701362aeb1ffe8e9a2eeee4000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000003d31941151218a84e5dbd34e892bfe12fc17fa000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000003ce1cf80589c6a8f1d87811ba70c3ab499c0fb000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000003b2b5f9d48ecd5c17ffcb6ca06d40a4d6fe8f4000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000003aa214a21ec6b3dac1737b24263b932d8ab7a6000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000003944480f55c0e9ecfa92307b66dc8d8fa3ccf2000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000385115d78dbb10fb51592b13343095a8455248000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000003701a01623a94f90d172ddcc566c42555436c8000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000360f6bf22a078d5d63dc40e9a70ede10914dd0000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000357f7b136d5dadfccda67a1b1a6a9a3089b79c000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000346c2de60afe71d1f206edcfb37ba145a14f7c000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000033332d6e445a3f0007bceb644daa318c719225000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000032910fef662934368d49e3ac4ab3848dadd989000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000031314e891911246becee4248a1126bc80ed66b000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000307118813d771de11c8305bd4991c43dbe801c000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000002f34eac76835bd6d7900dd1f49cbbc00be1bd1000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000002ef6873dee1829c0ab5425239057c96edebb51000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000002d2d532df2b5e040a56ed7579cb4c7995cbea4000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000002cb7796cd37ced6428c72aa657867bc6996d34000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000002b4b87efacbe56212f7169aa86d68bc1eedcc4000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000002a200f1acc19708810b2dcb1659956fe544fc1000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000029fe288ff06811f434419459f3e0d59b9a5e46000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000289bb33916909a8ede99359a78eb44db523f6f000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000277700cd3e813ad77fcd566d1e3937ddfc7895000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000026bf9a73fb5137d425c7660eb4d0b32be233a7000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000002512e4f334decddf8babaee1f1cfc12e483c4a000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000024ea63396bef481ebbf471d9c14a9f6e90ec33000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000231c41506ed20c5af3d1afe1db6feaeec150be000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000022d37418b2e80774e43e5517c1694150f4a8c6000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000215785d7a5694b232f07a7cb4cbbe499b28e3b000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000020acad6c390b8dc53972c91b3d61a9db1c4bc2000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000001fea628d33830e5515e52fb7e3f9a009b24317000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000001e4bb1c709413d815030490903e22fcfbdcfc5000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000001d7e189d0c0d5de5e6c38df1830b391869c80b000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000001c21c8af3f21df62eac26064c7bc88c387317e000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000001bfc9a502b74900e404619f5d0dda9c8e7e618000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000001a929ef80f1e66189404aca391ebf74ad64cee000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000019cbebfd57861cff6d5b469710c811804f38e0000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000001886c14a86fc405d1e5946e748a0f2098435a1000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000176268bd6c7ac0098516f3353b7c6661161311000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000016288f98f0ffab0def000d8013d6d49b078876000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000015dad58fe48fcdb5c581e60666ba19a9b128ce000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000014a3e765da7ae42dd18bed6563f37a731dee47000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000139113a098c2cb09d5c317dda3ccb4401579cc000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000124f49e65f74ceeb2c6d354abc74d548d5a74d000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000011e020c1c8613675b99c393410c6afa6bcf660000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000106216a6baa05f1f93dc44ffba20bc0d7abb46000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000000ff3c7e0b5c19447d5175cb4c6641cfa613152000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000000ea12d3b17f96ef79ef4012db9df43a3d6da1b000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000000d381af6561f165a44680afa06e2360fd1e060000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000000c68d29c01f7e5873a9e353ee9af4d9505be93000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000000b2dc121bd9114e7aab47754130f6148b38755000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000000a52cad719404896a55f2dc2ea28dc7a6a9249000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000009cc6575ddd868bc1476f7ea516af58125b0dd000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000086c57b20ac627f1b04b7bf50bb27330438b6b000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000007f34bc43d41cf3ec2e6f684c7b9b131b04b41000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000006680ad7845cfb115cd56f834385817e93999a000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000005a748d15de450cd488fbed9cc3b3213f042e5000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000004761973068828923e7c811dd7f5b8eee0bae5000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000031174fcd4f971249e4112f925209a16813137000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000002a311f7cf0aabfd3a248a89824bbd94a458a2000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000000015326bcf44c84a605afbdd5343de4aaf11387000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000000038a7a3cb80ec769c632b7b3e43525547ecd1000000000000000000000000c1a8b655edb36b637a7b46d74663652976a05f380c751b97341c993308e24edb00000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000eeee974ab6b3e9533ee99f306460cfc24adcdae000000000000000000000000008006dcc60696ba26af1545b72d44b80bc5c78228c2d14392ddcc4d35b4d4e04000002040102756f08000064a7b3b6e00d0002000a00000040bd8b5b936b6c00000001000103ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000dc93abe7ca3215a98add67ba73d9ff98e160c15dcb05d086f70c8c23dbae6ea200010081d8c4bd750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef1567701eeee974ab6b3e9533ee99f306460cfc24adcdae000000000000000000000000030f87d674aa6b7008264f715849426abde0d65113ecfe224bcb39ac012117b4f000101050202756f02554fff000002000103ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000003b56597243b97ab77b0e1a6552f50511e8f2f637c2f94ff063a35fd5cea5275b000200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef15677000003000103ffff50e1605b6f302850694291eb0e688ef1567700000000000000000000000069ab30e69e6391d4ca29676e59643154462df0b2d0d712cb5d5cd594033a4032000300010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef15677000004000103ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000009ee975ec8131d349800e0edffc85b016d5f948c5cb0eab9d071cfe72ac9b3506000400010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef15677000005000103ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000488ae75835825b0416849dcf358259e997d9166f587897406ccf72707470c124000500010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef15677000006000103ffff50e1605b6f302850694291eb0e688ef1567700000000000000000000000045fa70e6fb13b15d149700a56c70a24117710bbc42620795680f5afbc5ea2f7a000600010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef15677000007000103ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000fbc23a837b3cff288c250908c40cfb0a7bbb46a2b0473b39bc3f8aaaf7578ec1000700010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef156770000080003010801c0a80164000038a7a3cb80ec769c632b7b3e43525547ecd1000000000000000000000000f8d4fca5996439cd6cdb4c92c0027e21f498bcc179b50f38e9947bcda57666c400010801c0a80164000038a7a3cb80ec769c632b7b3e43525547ecd1000000000000000000000000f8d4fca5996439cd6cdb4c92c0027e21f498bcc179b50f38e9947bcda57666c40002ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000007564d72e569431c11f43312287692e6896e4f8af58cf2c5fec1d9b127c97d11f000800010000000000000000000000000000000000000000000000000000000000000000000129290a25000000000000000000000009000102ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000005bbd4a4c724bd4551ca9313e0eed2ad9a492a7c149bf69ac3bbad6f4fb1d18cf00090001000000000000000000000000000000000000000000000000000000000000000081d8c4bd7501dc93abe700000000000000000000000a000102ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000ff706c6e14d62c6d0793d89c66b60391c87af4759fb3a15debfc8e3e1766eca7000a0001000000000000000000000000000000000000000000000000000000000000000082d8c4bd750000000000000000000000000b000102ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000000bc0917c3d1cd9f0cc01ed8058f4f3260083ede981e4eab43206f2d3393258ae000b0001000000000000000000000000000000000000000000000000000000000000000083d8c4bd750000000000000000000000000c000102ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000001e86c4dbc517ee4a56e03594790414f6a7c8183a4a014c002e1ade7b87966819000c0001000000000000000000000000000000000000000000000000000000000000000084d8c4bd750000000000000000000000000d000102ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000003845aba050d681be6ab1d9242501d616f30ddebd28b122a0f7d16e77b9b7cf74000d0001000000000000000000000000000000000000000000000000000000000000000085d8c4bd750000000000000000000000000e000102ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000008bda122eb707958fdf824a2a2b19f8e91017b79572f940de2cc39142c87bb9cf000e0001000000000000000000000000000000000000000000000000000000000000000086d8c4bd750000000000000000000000000f000102ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000864583b387b186c92b2c5cfec65899bbbc3c51f50a6ab260c4a290a1c016ee11000f0001000000000000000000000000000000000000000000000000000000000000000087d8c4bd7500000000000000000000000010000102ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000a6c4ec4b2c2bfdae6efb2329c1275a7339678c08d67b8140111b59fd964a7cba001000010a418c97e2b7da7d7da8edda189ead1bc35a4e93b944f0e20d2c0c90ac114b9c88d8c4bd7500000000000001000038a7a3cb80ec769c632b7b3e43525547ecd1000000000011000202ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000009104536ec96724d11523f69cd640e35da901e9dff208cd9107ce062cae542b1b00110001b8179a30fe315283f15f2e638ddd16a880ee403e860ab8c9258ee51b5f7341b289d8c4bd75000000000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd10000000000000000000000009104536ec96724d11523f69cd640e35da901e9dff208cd9107ce062cae542b1b00110001b8179a30fe315283f15f2e638ddd16a880ee403e860ab8c9258ee51b5f7341b289d8c4bd7500000000000000000000000012000202ffff50e1605b6f302850694291eb0e688ef1567700000000000000000000000091969d50e68aeb4edee25ecbaf2e3381519ccb43ca485a48faac84fa6281ab7900120001eca6a964b55ab3c3efacf0001b1ce0458257e17e3ce5771c6ed1ed5908a29d748ad8c4bd75000000000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd100000000000000000000000091969d50e68aeb4edee25ecbaf2e3381519ccb43ca485a48faac84fa6281ab7900120001eca6a964b55ab3c3efacf0001b1ce0458257e17e3ce5771c6ed1ed5908a29d748ad8c4bd7500000000000000000000000013000202ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000009b80fd78a29c31c364e1c9f158f249b4fde77bd74a6dd8bcb1ea73ba12e5aca300130001a76cde6dfdc39b2790615b184b5456e68788adab1e7fb1fd583eacdc4dae1f8a8bd8c4bd75000000000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd10000000000000000000000009b80fd78a29c31c364e1c9f158f249b4fde77bd74a6dd8bcb1ea73ba12e5aca300130001a76cde6dfdc39b2790615b184b5456e68788adab1e7fb1fd583eacdc4dae1f8a8bd8c4bd7500000000000000000000000014000202ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000000713a8eab9911db94237b3ea82acbc72fdb6b0fa33650ea075230ceffb7fdee60014000146aa9bd5b4eccb68b6d152b88a0eadc42aa5502356e4d686b842a15b8ed9cb6b8cd8c4bd75000000000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd10000000000000000000000000713a8eab9911db94237b3ea82acbc72fdb6b0fa33650ea075230ceffb7fdee60014000146aa9bd5b4eccb68b6d152b88a0eadc42aa5502356e4d686b842a15b8ed9cb6b8cd8c4bd7500000000000000000000000015000202ffff50e1605b6f302850694291eb0e688ef156770000000000000000000000004a5e4d9694fbb535cb3a391fac1487bbad9ebc5374dd2e68354405a07657ba6200150001012745ee7686ded752a5b17cb075831501663658d3650d831bb83de31149942b8dd8c4bd75000000000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd10000000000000000000000004a5e4d9694fbb535cb3a391fac1487bbad9ebc5374dd2e68354405a07657ba6200150001012745ee7686ded752a5b17cb075831501663658d3650d831bb83de31149942b8dd8c4bd7500000000000000000000000016000202ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000281dafbd1237fa6a19dae5825d24adab028eff10005feb32cc650e4588f3105700160001e7adf3e09f0e524eea80903543940cacce433f0806c47928c15797721cfd477b8ed8c4bd75000000000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd1000000000000000000000000281dafbd1237fa6a19dae5825d24adab028eff10005feb32cc650e4588f3105700160001e7adf3e09f0e524eea80903543940cacce433f0806c47928c15797721cfd477b8ed8c4bd7500000000000000000000000017000202ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000759ffbd2492ea85ab7aa01eaf169436ceb714fda4ff37fb3b13810fc4041c7150017000127653677950a08b4af9b39e9140c7d7a6ddfdcad782483379419383f4cc05c928fd8c4bd75000000000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd1000000000000000000000000759ffbd2492ea85ab7aa01eaf169436ceb714fda4ff37fb3b13810fc4041c7150017000127653677950a08b4af9b39e9140c7d7a6ddfdcad782483379419383f4cc05c928fd8c4bd7500000000000000000000000018000202ffff50e1605b6f302850694291eb0e688ef15677000000000000000000000000e3ed2260e323c71b3e1867302969501a173de1b37d0471dae010a515631f5d4400180001a62a88703d7344b214ee4cd8a511053194d1cad0f05564b656b923b26111088390d8c4bd75000001000038a7000000000000000002000038a7a3cb80ec769c632b7b3e43525547ecd1000000000000000000000000e3ed2260e323c71b3e1867302969501a173de1b37d0471dae010a515631f5d4400180001a62a88703d7344b214ee4cd8a511053194d1cad0f05564b656b923b26111088390d8c4bd75000001000038a7000000000000000000" },
												new ZoneGenesis {Zone = Zone.Testnet1, Crypto = new EthereumCryptography(), Rounds = "00000103673890983bfae2742487ebed21790c84a14acd75290f6470829e88af0cb5a50d4ca93c3a13806418c7d420c942f321954022fea230f0fa7be846dc714564ba161b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001eeee974ab6b3e9533ee99f306460cfc24adcdae000ffff50e1605b6f302850694291eb0e688ef1567741a613e741d307d7dec103dc0900ede1b32b1ee318b7ec98a65eb5c64749030a2d11ba8686b28492da159ceae32d5a95871e3cf4983cbf263d3abebb0ac0a309751c000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000019c295431fe249d39e495f0d62f25a0410255143d339d47c942e5db47992eff11119f693df7228eea949a8f9eb3d1066ba637094d75b659b2f67907e849681131b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000f9bf6ed9233b4f6cac719dac16c2bb183cfb9d15e8e26beee7d438ec56270800b20a40c45164365b146dfb7971f5bc9199a60bd18effd567aaef9394e81119f1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000099d36d52e05b03c26f8dcd4e6645090f362cbf6d4fdb0ed6d230e68fbdc71d5d5bce04ea3d3943ec2f1d9506f88bc98d3eff3f1547081d234c8157ba1632dc081c000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000011eb8f15bb22b6415883f3b8b5ac3005f9aa7ff78202819e68b2edff38e54b6c1c0b1fb96abdc1eacac0ed306ce5f04f97a39b29876817843ee5f0e2193ff4c81b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000554cdbf30558c0176122dd056e92ef5da22f77058960f0441bc8299a23c1c079191290a09eae4995cf83a0a605cbf4d015374b870eec2d57919020fa7d2e36351b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000098a5ec2dd55536de15a8246f225a86310444f198a17c6d135d186af7eb933fd903105baf4342d47a94a6188db2e13636d310761552600d29c5a2af49ec9701d91b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000655dd63120aefa1a20169021c74d716ae4b577d54c8973afce68d8fa3d08d2e70ffddfd9084368de00c5ebb57169035900ed9b89292d951ec10abc97fa866e571c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000271378daa9117e8bfa81eacf0508ca28af318a1473d7fdab704ca14d84b2b0e664ccccc0e66c8b9b1991a1f97ec996eef55728a9c29c260680c2cb894a9ee9391c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000473533a5657cf3555bb3261978b767f0d62fe5e9f131aada5bdf8cf5e4efb5e244712e32841481ae0c83c902be3c9d349300608e76879bdda0de60a6f195c6e61b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000093c5e802d07fef36fc4e2ba5a52fa094d0724f2c23ce92be562f858bff811bb562a0f6aa24dfbbfb90523a6cf90d1fc1ccade9bed74dd2a95c62acbe9b5c69c81b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000fb5f6d396a427b991619027cd344637ecf12a716d93cddf3ba997bdaa0536c7c1cc77dc78cb0ead1507d3fcebb931ee451148a8b9329879dbc45c01a7c9243c71b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000031e8850d4f84addec8b3fd04321440b60bca763686cba54f4b2b11bf5570c8353bd64fa421e7c3643a80f7c31bb75852c985d3c70af82a58184c9b018dec19321c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000de5bcaad71c500274b75ddb486d0135dcbb5917cef4811df675454637393a7b628cd79397b4d19038816f2af2925e60fcf98dc47a9a88c8ad5a10ce7069d137d1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000093e0a3747c5585848580229a8f7550b7988b7831fd965f91f6c638ee8e538e410674f9638ecb8ec539f1b640d2bffdf1f929912db6fec56e1b550451a785fa241b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600006eb7930dbb9b2f412209abcf5eadc47c92dafe1515d18706cdc9ecdb22a675f11685c722b677ef3d8ba186df5c394cbeaf8843f364e858d060b69f563ac487f21b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600005879478d0f37288755bfe19a858a6a608443e1421c99069df43d5c07ac7b8a084324a68d66f2bd8c0ad883db52521075780851e79cdd2002dc636f0edbf87f491c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000cfbe21a13cc9d990ce92ecdf2bbb593d8851748aa7bf7e517dd5c54811060221427a2bb2e12f317b1e0ab3f973598970bc76733b566160d77d079cb8906f14801b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000c7e2ef9b528b11d83e0797e94fa43da6ca42010f5c249ead82f3d083d755c8212c129235b9bf439775c68836da8afd00fe78dd83f395263edfc1228115fda3841b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000009034048dee0b9d974ac00399cca8c4cff51d2e66a1f29cbc9a0650c46ecde5a62718e33584801c5a9b5360ab8cfa53c554f0acac998ea8f4250225dd5cd62be1c000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600005e62bb7b0a11080f79cd11038dceeb4d3dd6d696d324caa5189f275ed29c7af60958468c2033fd10f4ebbd6e6815093f95d0d5b9910560786f8336480a4a18261c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000cdeefd653b12c6b47954281eb5ed4e5b05ed064504359b94271fc1db46466e4c1eba9fd9f03da0a158ddeb3232902523756e2ea634158114202949547447b08c1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600005dbec034fa56532b7cdca356f171a4377743c7a246ac9c2050d20a00176d35df34cb49b0405749fa5f64850e01d9ed93a972fa78dd4c717ae809b3a864bbc7341b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000049c669eb5e1f8be55498718a9285f7006acc6c3a639f28194deec55f802b96ba2794875abf74429c81e188efa980416799d111ab5ebff2d9ce5fa5c336135db71c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000ee2e12997403abbbd729431cf3a75bc9b4db29b3af9cba2775e8caa5033b99ae2512404d5c8a0341d377dbfe5208a53f68bbf69884b6f93c3b7009a75c16f4d21c000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600003432f387942b3b41e9b01bd44e566b451354193ec7fa14fff6baf80dc9120b3d497ea4901fbd31464940cdd891daead0ff13cb0d78f9fb57f45b1e2b7b0496191b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000004f9f24438c42a3ea422e8b9887c39d257b73def5b8857c2a44d06c113707bd41642565839cc08ffb67cce4600eefffa50eaef1ab91404aa8cb659a09daea4431c000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000064ddbe0d2f304ed7c847d4aeb695e05ef6788574b9b7ee8d908aebc97416035c79e2f8dab62198e1e5910cdcd22c48a90a0a1796f30fa5605d1f2eb82f5bf6981b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000a93a63fa7b59eacf378a30db54e78321db82d21c568b0604f128e2f08a735ea09cd8359eda6f83959513b06e786489567a242497456aa098d7bff9f987226d01c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000985ca0a2d8dda9b255437db15504f967d09025aaa5dcaaa63643fd1a0bafaa110459ac373982eb1583fa4e607cd83f877b7cb2c5ff768597038ab2e1867b82c31c000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000393992a3758698b449e846d945571421567f5b702455924801b0f08b18ba32a66d0112b5fc5bf5c01095dcd53d780604ccd9a6469f49a017945d69bcb5bc0871c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000d98c1e24a301d2a7686cce6a88f1587a49a56987122fe97005c3e41a95e758b15ff9abb5e037e1476d7dd5874758c95baf6deefc0b69b2a56c0e7d2c617381d51b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600005c88b6ba17c6b36d3038f89cd9d5b09cc82e8ac7c90746482ed350dca62d70d800778a1a4e3d97aaa49af649698af0539229c46fdb223f6bdb926518aef3ac611b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000077defe1ecd8f6e76bb511f0562c3df8e7d29e4efde513e04141eea99c904bb4e7c45ab1e9d0370ecffbf8fa36147ea2d6d313e2650936c31e303016b13f64c911b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000f049651a9542e5b5704aebe928f23f9c2120c5706c2f811de1cee810649c32d5190d2392e1ee20dc859eb332683062478701317fe1d29bad8f5b2fa28312ee51b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600008472b33befae16d7529e8893ecced9543d23d78acc5cceb8db71d7dff8722bca57fe2636d6859aa1bc5aa260fce94e43b27ae70fed3477806e35b922be7ae37f1c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000ba5447cfb494b8476aa5470157beade48293ccf27ec9a90e7c0da158bc4633d130122f2f8905264e9f64d4adcd58916bc69f315de205bd87c60051437d76184f1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000e33504af3a81d6de569df3a8c54add536a565a8e4d0029c09e720c049e020e7223a6df50ce8ec67506c8f3fb47bd3b3875304d05e61ad1bb5f720318554e1b291c000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000057b55eabfde27f055959fe4f172a6afd4712163ffbd10bb3707818fcbf06c67d4e5b88b9ff2a6b8e3250548f2e975a4838dd7be1912f869208ee92237c93b7e11c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000987ba82899850988cab4a0d69260429bb3280696be2d2ca0ceb0021932ce61f50d337c86175d9f4f477d273038540a2d1ac1ff1f49aaa09b5c4d351166ed00f31b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000484b407a0c5c01fef7b41e00c8576ceb95965670c365c5be330f1b1d543cc0d458fe537d11e1591c640c95165c95504c262170ac7c0d07245392ad9a3629b3531c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000fa30f2ed44cb499c1cdfe916bc3da32568a303ff3b0a0280691238b09ab0c00501b397ebdd1720adce8d83b0c897eac624054511c57dfbbbba02bb26553fbbdd1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000a85aeb99ba1efb40862bc3472ae3e5cd1ab5c1522f6920f38ee01761818e6564182ac7d07a55f53a22bae4a89d31e3daed3c9d18ad6c317861e4ba1720404c671b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000f2bd13a44439ce1ff46d491ba5432a4984adaf61b1ba280f08456d118c2a568e5f543928b419805a1d99bafd46a5892a3130a7846948347812c76fb1eec80d631c000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600005740d65a8ae351a0ce911efedf43d06d81cd4ee6a19178fc21edac1d5670c925086d207253b4a78473ca6775c1de0aee1834435fbc160b2f49a8c394975c72ec1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000153777fd26643df12665aaefaa8506fb40b00f0a2775b7ec6b5af77773ebe79f7cbdb44eef08e0069734902ad9fb1227942fee2faf750476a8f18d2537bfab881b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000bef890e1c7817cd5fce6cc028a8a07e2f299fb939564fdc10b2a435bb7db2fab6888d378e718ac9415746e04d3145f3b776ad6a9457a56fb9d9d1276b1d223f41b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000bbf9218d39e9eb56a182f379e3c0945bec6aa8d8029886e0897d756c8d4bb60f125d4f0aa055367e540a9353900c7d62b5101c72c69c5cd371e98547791872fb1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000bb18e45b62ebd8bb9b82653531f43c9691ab05000524e2be8574f970fb2f6dcc7a4392f2cd6545a11e8159105e5ca79c8261f1427cd72b12f5f1d01d824451ac1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600005bf7de19c9b22e9d5531734d09551e49d4f87853566014bc0491289928853679309a9bdb4ae47bcc65ed113a2a0da2c78497b8ac272d03194d7945ec05f359891b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000c4929fb8fc1fd2447092f575ffebe8613c9d88c707824478f7f0f949d1eafa7d7012cc54e9c27edc9d6a3bb31654786086221f7ff5f3b49ec40e76c54bd2926c1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000058a4a6f9e174ba562ff2b8a5a18ef8243e8327a9539cb9dd88a5006fe406582f6dacac5052a5bee632407bb80c13a4c8b34c52b73d9a3db16fb0db16bd3940561c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000cffc1430bcbc866c2f71351121335d5471474b7256666cd889dec4f85c4113bf21fbcfb00ca916015b0fb81790bf20ad6fc606550e632d09a3434faf4a5cb22f1c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000127cc445068170d6116e5cc8d2f6e892d41ab0bf485df46522e94707d7a6acd809ac46ad7f73924bbbaf45ef5c78cedae335db3717ab9e239547947b4f19e7a11c000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600000e090c9f0c98d3eea99f7e1c2b8e924bef0594df5ce80d2871b20213cf363fd75665e8edb3dcf5c682e3ca939eed518bad586cb0747fb69efc9af6ba7bd5433b1c000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000027a83ab964412c1576b7f599b3db0bfa5e9ffa675814f788e6c86ff863e39b6c1ce6aac769b52dff71fa326dd1d5fe285d59edc854777fd5c81f66b571ae25bd1c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000580558aadb5a4d88bc4ec85016789629fb5efa2391039526170ec0ccb2609f8e73408aff08429a3a3084eaa19f05289122ad877d953295ed6a62f965514f76cc1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000829e3161b1dc5906400a1559d5d1e4947e010c4a827b33fa9f350aaa435c4af840253192cfc311f597868b692c4866d7c1ab5cf62b2cb9e5f2c058d341e4cf4f1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600001bd2000deb38e29b02a71407aa20f4ce3dba4a58ffc579c845197e375446d8444715a14e9d476c31c28b868d7a17cc382b312f878bdcb9c9efc8580a8f16e1a81c000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600001fd703ac43950617292d6f3f5805c8dd0ae51cc5fb60ade2543b3ee958429deb738df6a69bde7aa4dd173bfbec410d145b544a6bcfdf061215e464d41bbd1f8e1b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600001bee255dc9822284b6f43f406e9391167898e46d31ac55477f7cad1aaede0c2039a4fbd68bde84353343e0d7d8f857aca93df8664849babc286c80d98ad26d201b000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000976ba11fa44636515657c69b9f91233bf4f36d4506972962dfc868ab24d7d9ad7db3b8efc48d26fd34d8a9a1987b5208bf74ee7f85530d1f09758c1685abc81d1c000201010b0050dad7f5b1317feac800000200090000a0dec5adc93536000049bf9049a3460068936081fd12c3d78c3ad3b359533fdfb802ef13aff494315a5d8b12096af8d29af8def06fdcbf82a0a96216ccfe97f8c5d73e4f70149ad1ce1c000201010b0050dad7f5b1317feac800000200090000a0dec5adc935360000f4bb024896f7a42d0913f17af4f7cad9af3fb2d6b63fbb29b0da14e768bda8a12af6e994186f77b43ffb6f96cad2c53016b2bd076bf3b21d02e0bc863670df961b000201010b0050dad7f5b1317feac800000200090000a0dec5adc9353600008e834381639e6d4458dd9765b926d0c9673edb4cd353b57e2f700b8599314ec55e6409b2b2d741d4da344f8b5206fd0462ab51463bf0c5603bad48034c7dea4a1c0002040102756f08000064a7b3b6e00d0002000a00000040bd8b5b936b6c00000001000103aac59eda8327adc7116b0b9bd6e83467ac863230ee689e67431b88b10191a6173edb38cb5b3ff1c80177a26fe6da5cea3089f8bec75bdbdb607608a842b39b2f1b010081d8c4bd750000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef1567701d6728b42b653127548698491285db2b5f879e0e641e0ca5d945825abbe4c21f9705eacfbd2cacb4e6567e3946a07fccb289cac9e2fb4a010b139dccaa83094451c0101050202756f02554fff0000020001031e05e792b9e9447ad8435ae062a5bd2b5d70f3ccf4dfe3d1cc10a745267706e66f2f94e6946905fa56cb11acc856570820bf3eb12df4d80e07cfdf69875582f11b0200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef15677000003000103e1d462244a6bc2006fddf2e070e4b836da1c5fe2d40aace8a3447accf1d347dd3f2d42d13b706d52d58b0556776ebd2f4b9183460ab210ac92f43cce95802ec91b0300010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef1567700000400010316460169adf44f7b9fd1853ea82f82c4b76ffcbfc6b2511d3790c3ccd122e6060ed9a7392a6adece4a40acafd3b753ea03f59f9329ac0b297e323c5a42ea1ea41b0400010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef15677000005000103455a01d432d7431a11c700ce248de1dec66a40cf5617ef3d73f9b3337d77b4fd152e86a7d3cd8e4f8d10d9d6de730affe8991640b37bc19817052b9ad97dbc281c0500010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef156770000060001034ae637df1a41d48fafc0228cd6f758bb829f9a0995e1b3c9fe04f2daf74019a80e332eef56819d89267ac4c8a6e6fab5eb723d0b545912329b386a4aafa121741c0600010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef1567700000700010370f14c248df1c6e3a613133b0cecefc0064eb2bb1c96bfb1fe3d519b6aadf2ea12e7a0086d12c1a57edfbdcb01e48f0381d6122188b06baa61fae869a7f17c921b0700010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff50e1605b6f302850694291eb0e688ef156770000080003010801a87736c81a713ef8a4e9b1d0f9a745bc001e9dfe618ba70dcfdd59df1d64ac6bfa19c7472e33e0d376b48b8552016f3977aff42d746e8277f9b78972b7ab9bfc6041c6731c010801a87736c81a713ef8a4e9b1d0f9a745bc001e9dfe618ba70dcfdd59df1d64ac6bfa19c7472e33e0d376b48b8552016f3977aff42d746e8277f9b78972b7ab9bfc6041c6731c029256cc2168bae7f9f133af2df1ecf1a8e146f355cec06e0542ca684facf0d9ca1affd9e30e7d77b0f2d999c3ebf070e197db1d774098dcbfbfcabd3a50bae8d21c08000100000000000000000000000000000000000000000000000000000000000000000001c798cfa3000000000000000000000009000102b4792ba7bf8ddcdfbb1859cab1f0fe39d6cdc03058c1e6ef2df5356e8763fa317a19c3cc0fafc7ffc21d677e5fb5c45de9777543571220f7f82bbc8ea79f9c571c090001000000000000000000000000000000000000000000000000000000000000000081d8c4bd75015d8ad11400000000000000000000000a0001025d91e0cc66eee911c3d1d10e7f0f6bb00ac327542e00d542c8bc79245a95b68673ea5318f60243392a37e71f84ec7f3315c1c9daab12b7d5a68a611cfe9f7ebf1b0a0001000000000000000000000000000000000000000000000000000000000000000082d8c4bd750000000000000000000000000b000102da8ab63c4b6611424e65aff929725841e6ba01278b87e0242c83c34cb84409ab75de581d92e4ad4b9ea5df7085ce4af29e656756cb00a2a6d9ca7d804a2011d41b0b0001000000000000000000000000000000000000000000000000000000000000000083d8c4bd750000000000000000000000000c0001024111401e0fd6d6a92a4c0f999020c6ae104daa8b93baa8b11344004f884780d14e747815052d9994e064655bb48c96489db5532cd9d8ab02d885b1254e8fcd491b0c0001000000000000000000000000000000000000000000000000000000000000000084d8c4bd750000000000000000000000000d000102c49a59fa0600fb4e77d5dd139b870dd0f10567f2638ee44427d895a18160ed1e6791c1489d74de25c410c3e2053842683987269273036fb82b788a755e5688a41c0d0001000000000000000000000000000000000000000000000000000000000000000085d8c4bd750000000000000000000000000e000102b93b8a43dcc9de52ba162918ba494449123feff1c0454c167164d70d9da3388526fd96719660fcf2ded1943e2416cf54f04aea476f1bc49717ed6722b2a763ee1b0e0001000000000000000000000000000000000000000000000000000000000000000086d8c4bd750000000000000000000000000f0001027c9fc246d1b8c2a275e4f5ca684aec6866ce0518c81b45b108abac4a40e922ff133c6d0dfbb75e444960b506129af72e8912ef9617e9801f2335133cc56f58e21c0f0001000000000000000000000000000000000000000000000000000000000000000087d8c4bd750000000000000000000000001000010229d805e1a198f795eea3f83cedcabbab069cbdbaed51c5a9b3b91126b87a3bf730622895b48f4d36cc653ada480cc9f1cc833325db2df7f2db4ddb92d1ce7d391b100001af769eb0e0198b35107459b6c2762f5a9a3f23f9323853837b9df54ab09c0ade88d8c4bd7500000000000001000038a7a3cb80ec769c632b7b3e43525547ecd10000000000110002025f90b1cff9a2f05024aae83fbaaaceafd08f619121f79c701fcb32ae48c72a484cdd7ca2968000b0d5bbcda3cb5e15305fac18cacc19231f85c073a72eafacd91c1100012b501c0d38b5c38985c512bf781821b9e25722114a48a46871766ccbe3857a1289d8c4bd750000000000000000000000024645a2fa21e93f476b3c9fc34ef6ffe3b3504cd569b08a892e2173ae8f062ff136a8f70509cd4312d3a62a1a65a8414288c22a20bf7543b212a4e55187bba1421c1100012b501c0d38b5c38985c512bf781821b9e25722114a48a46871766ccbe3857a1289d8c4bd7500000000000000000000000012000202bac3c67dbe40125ee3eb733253854f071b72de9f1abeb904e305dcbed7b339247d080517f3df69b9f63fb16a09d813e89a17fac6a6afe59cdad4132b05cf25c21b120001c8fb7c8f067463f6962971e2a7a03be65b6ff7363acbed81e54432f38fadfc128ad8c4bd750000000000000000000000028a9218b1982fd8e462b2964cf14acef2851825cd1f099027c4b23d4b6a246ad654a4c7ecd04db8d495fef81019a78b3e09f87597c2415e8445cbadc8a1fcaad91c120001c8fb7c8f067463f6962971e2a7a03be65b6ff7363acbed81e54432f38fadfc128ad8c4bd7500000000000000000000000013000202338318d7d0b7f82adfa5d6a83ef06f1504755ce6010847a8d41190685fe39ff5247f6e1074cf5fe7d730286c665dc021eaa9bcdced383e1074513a4283a5cf7e1c130001a7ceb2ae81a49b95281d6b25ae9b9ace8670a798ce5a415f4e218dba6428278b8bd8c4bd75000000000000000000000002e76bd82a7dd31fe86a993db3a0dc0e46812d91b367fb06c6e228cf51a699d4bf5676f02b94444f059603db95124f8e3e805534c2790909a1a6096d577a5d0f991c130001a7ceb2ae81a49b95281d6b25ae9b9ace8670a798ce5a415f4e218dba6428278b8bd8c4bd7500000000000000000000000014000202a277957c5fea8dfebe4cebde0c4f6c8839c61dfe8745059b41702395479fb18f5591ee18b9d102ce2e680efd1fb5c128d21aaacefe42d4396e510f6e70ee89aa1b1400019fa4bd191f4da3f2b99e51e494dd6bdd9713ecfc6d1adc8d01d7e0ea5b63b9178cd8c4bd7500000000000000000000000212cd1ab03cd575b91da11cca17c3e85344e4ffa2deb65e3e28b8ee619b3c008e6d71105dd23d47da9faa2507455ca8ba8d5369f46878722f7d45493a3782a1411b1400019fa4bd191f4da3f2b99e51e494dd6bdd9713ecfc6d1adc8d01d7e0ea5b63b9178cd8c4bd750000000000000000000000001500020290f98bed4bd35e38a33f2ebbd69343e05ccdc2853ea5c632a2ffd8f061b6847a68ca2f6dd88705d403b030180a41e531900a76ed08f41258287b2d35b845514d1b15000119404eb207013966e64a62998f13bc833e29693d98225aca6054239d1c76827d8dd8c4bd750000000000000000000000024a7e16d4e28e604f0f55a619a0a00264d5e6977c9e70df005e1e0b2f3d58078c0cd27b1c6b37bf67d6a0b2890bdddac469dad9fcda2cab64be58d34ce68f60411c15000119404eb207013966e64a62998f13bc833e29693d98225aca6054239d1c76827d8dd8c4bd7500000000000000000000000016000202d03fc1a59d197c3d1a0cc2c88fea808df01b64ad042dd0b93935ca81050d38b81abc717324ab7a123bffd7db9f93f43b8d7a9bdf05d20062ceeeb6df748735c41c16000157e89d99ed3e0be69718c73fd8a572c984e5edbe19240f3eded8971e436303b18ed8c4bd7500000000000000000000000220076cedd4caaf52af2fe5f5ac603ab9317d095e0bb894e45e6f45eb1f23e88e1c6557d7427a0f8b941edb6d1317777c69c8f01fa71e7e32c1c58cb8f1b1c7931b16000157e89d99ed3e0be69718c73fd8a572c984e5edbe19240f3eded8971e436303b18ed8c4bd7500000000000000000000000017000202612c6feeee401d0ed8ad5608ef7ab06009624a74848fa24e75081f6b1bdb55e84c8e68a1f1d04250831afe4b829e008d3c96e73caf86691ca147b5f4758392321c170001094d0fece02672f298e677b345635841d6ac994c94ddc30ecb7a68ec93e3f8208fd8c4bd75000000000000000000000002ce37229866dfc9e85237d6d27873cbf8831e1e11e21a7272c2e71b058703cece513ec9aa993d6b5c15a5ebf05d6a3a2dd63eac15ae628b90e8a07222c821ed6a1c170001094d0fece02672f298e677b345635841d6ac994c94ddc30ecb7a68ec93e3f8208fd8c4bd7500000000000000000000000018000202674ea19cde58246bcb4f33bed0c7845024ba0a2649cbd69c15032b56253653c4276616ebd941c075b11934dfbc31dbcd759967d889c721e731228435e228bd991c18000129c338f7cad8b21f997c871a6018f1f27b1fa3fe198380bf091ec0e78ffd6af390d8c4bd75000001000038a7000000000000000002a96f35137226f5dbdc33333e2bff89cc109a2f81a3d1f9721aebec563754c12411c46ed0e04fa781f504b29911bcb79550c424620eee16a4c8213e312b46034e1b18000129c338f7cad8b21f997c871a6018f1f27b1fa3fe198380bf091ec0e78ffd6af390d8c4bd75000001000038a7000000000000000000"},
											};

		public Round						LastConfirmedRound;
		public Round						LastCommittedRound;
		public Round						LastNonEmptyRound	=> Tail.FirstOrDefault(i => i.Blocks.Any()) ?? LastConfirmedRound;
		public Round						LastPayloadRound	=> Tail.FirstOrDefault(i => i.Blocks.Any(i => i is Payload)) ?? LastConfirmedRound;

		public const string					ChainFamilyName = "Chain";
		public ColumnFamilyHandle			ChainFamily	=> Engine.GetColumnFamily(ChainFamilyName);

		public static int					GetValidityPeriod(int rid) => rid + Pitch;

		public Database(Settings settings, Log log, Vault vault, RocksDb engine)
		{
			Settings = settings;
			Log = log;
			Engine = engine;

			Accounts = new (this);
			Authors = new (this);
			Products = new (this);
			Realizations = new (this);
			Releases = new (this);

			BaseState = Engine.Get(BaseStateKey);

			if(BaseState != null)
			{
				var r = new BinaryReader(new MemoryStream(BaseState));
		
				LastCommittedRound			= new Round(this){Id = r.Read7BitEncodedInt()};
				LastCommittedRound.Hash		= r.ReadSha3();
				LastCommittedRound.Time		= r.ReadTime();
				LastCommittedRound.WeiSpent	= r.ReadBigInteger();
				LastCommittedRound.Factor	= r.ReadCoin();
				LastCommittedRound.Emission	= r.ReadCoin();
				LastCommittedRound.Members	= r.ReadList<Member>();
				LastCommittedRound.Funds	= r.ReadList<Account>();

				LoadedRounds.Add(LastCommittedRound.Id, LastCommittedRound);

				Hashify();

				if(!BaseHash.SequenceEqual(Engine.Get(__BaseHashKey)))
				{
					throw new IntegrityException("");
				}
			}

			if(Settings.Database.Chain)
			{
				var chainstate = Engine.Get(ChainStateKey);

				if(chainstate == null || !Engine.Get(GenesisKey).SequenceEqual(Genesis.Rounds.HexToByteArray()))
				{
					Tail.Clear();

					var ips = settings.Zone.Initials;
	
					if(Settings.Dev.GenerateGenesis)
					{
						var s = new MemoryStream();
						var w = new BinaryWriter(s);

						void write(int rid)
						{
							var r = FindRound(rid);
							r.ConfirmedPayloads = r.Payloads.ToList();
							r.Hashify(r.Id > 0 ? FindRound(rid - 1).Hash : Cryptography.ZeroHash);
							r.Write(w);
						}
	
						var jr = new MembersJoinRequest(this)
									{
										RoundId	= Pitch,
										IPs		= new [] {ips[0]}
									};
// 
 						jr.Sign(Settings.Secret.Fathers[0]);
// 						jr.Write(w);

						var b0 = new Payload(this)
									{
										RoundId		= 0,
										TimeDelta	= 0,
										Consensus	= Consensus.Empty,
									};

						var t = new Transaction(Settings, Settings.Secret.OrgAccount);
						t.AddOperation(new Emission(Settings.Secret.OrgAccount, Web3.Convert.ToWei(512_000, UnitConversion.EthUnit.Ether), 0){ Id = 0 });
						t.AddOperation(new AuthorBid(Settings.Secret.OrgAccount, "uo", 1){ Id = 1 });
						t.Sign(Settings.Secret.GenAccount, 0);
						b0.AddNext(t);
						
						void emmit(Dictionary<Account, AccountEntry> accs)
						{
							for(int i = 0; i < ips.Length; i++)
							{
								for(int j = 0; j < Zone.GeneratorsPerIP; j++)
								{
									var f = Settings.Secret.Fathers[i * Zone.GeneratorsPerIP + j];
						
									var t = new Transaction(Settings, f);
									t.AddOperation(new Emission(f, Web3.Convert.ToWei(1000, UnitConversion.EthUnit.Ether), 0){ Id = 0 });
									
									if(accs != null)
									{
										t.AddOperation(new CandidacyDeclaration(f, accs[f].Balance - 1){ Id = 1 });
									}

									t.Sign(Settings.Secret.GenAccount, 0);
	
									b0.AddNext(t);
								}
							}

							b0.Sign(Settings.Secret.GenAccount);
							Add(b0, true);
						}
						
						emmit(null);

						Execute(Tail.First(), Tail.First().Payloads, null);
						var accs = Tail.First().AffectedAccounts;
						Tail.Clear();
						b0.Transactions.Clear();
						b0.AddNext(t);

						emmit(accs);

						b0.FundJoiners.Add(Settings.Secret.OrgAccount);
	
						write(0);
						
						for(int i = 1; i < Pitch; i++)
						{
							var b = new Payload(this)
									{
										RoundId		= i,
										TimeDelta	= i == 1 ? ((long)TimeSpan.FromDays(365).TotalMilliseconds + 1) : 1,  //new AdmsTime(AdmsTime.FromYears(datebase + i).Ticks + 1),
										Consensus	= Consensus.Empty,
									};
	
							if(i == 1)
							{
								t = new Transaction(Settings, Settings.Secret.OrgAccount);
								t.AddOperation(new AuthorRegistration(Settings.Secret.OrgAccount, "uo", "UO", 255){ Id = 2 });
								t.Sign(Settings.Secret.GenAccount, i);
								b.AddNext(t);
							}
								
							b.Sign(Settings.Secret.GenAccount);
							Add(b, false);
	
							write(i);
						}
	
						Add(jr, false);

						for(int i = Pitch; i <= LastGenesisRound; i++)
						{
							var p = GetRound(i - Pitch);
	
							var b = new Vote(this)
									{
										RoundId		= i,
										TimeDelta	= 1,  //new AdmsTime(AdmsTime.FromYears(datebase + i).Ticks + 1),
										Consensus	= ProposeConsensus(p)
									};

							if(i == jr.RoundId)
							{
								Add(jr, false);
							}
		
							if(i == Pitch * 2)
								b.Joiners.Add(Settings.Secret.Fathers[0]);
	
							b.Sign(Settings.Secret.GenAccount);
							Add(b, false);
	
							if(i > LastGenesisRound - Pitch)
							{
								var v = new Vote(this)
										{
											RoundId		= i,
											TimeDelta	= 1,  //new AdmsTime(AdmsTime.FromYears(datebase + i).Ticks + 1),
											Consensus	= ProposeConsensus(p)
										};
	
								v.Sign(Settings.Secret.Fathers[0]);
								Add(v, false);
							}

							write(i);
						}
						
						var g = s.ToArray().ToHex();
						
						if(g != Genesis.Rounds)
							throw new IntegrityException("Genesis update needed");
						
						Tail.Clear();
						//JoinRequests.Clear();
					}
	
 					var rd = new BinaryReader(new MemoryStream(Genesises.Find(i => i.Zone == Settings.Zone && i.Crypto.GetType() == Cryptography.Current.GetType()).Rounds.HexToByteArray()));
// 
// 					var jr0 = new MembersJoinRequest(this);
// 					jr0.Read(rd);
						
					for(int i = 0; i <= LastGenesisRound; i++)
					{
						var r = new Round(this);
						r.Read(rd);
						r.Voted = true;
		
						Tail.Insert(0, r);
				
						if(i == Pitch * 2)
						{
							r.ConfirmedJoiners.Add(new Member {Generator = SecretSettings.Father0, IPs = new [] {ips[0]}});
							r.ConfirmedFundJoiners.Add(SecretSettings.Org);
						}
	
						foreach(var p in r.Payloads)
							p.Confirmed = true;
	
						if(r.Id > 0)
							r.Time = CalculateTime(r, r.Unique);
	
						if(i <= LastGenesisRound - Pitch)
							Confirm(r, true);
					}


					//jr0.Read(new BinaryReader(new MemoryStream(Genesises.Find(i => i.Zone == Settings.Zone && i.Crypto.GetType() == Cryptography.Current.GetType()).JoinRequest.HexToByteArray())));
	
					if(!Tail.All(i => i.Payloads.All(i => i.Transactions.All(i => i.Operations.All(i => i.Error == null)))))
					{
						throw new IntegrityException("Genesis construction failed");
					}
				
					Engine.Put(GenesisKey, Genesis.Rounds.HexToByteArray());
				}
				else
				{
					var rd = new BinaryReader(new MemoryStream(chainstate));

					var lcr = FindRound(rd.Read7BitEncodedInt());
					
// 					w.Write(round.Time);
// 					w.Write(round.WeiSpent);
// 					w.Write(round.Factor);
// 					w.Write(round.Emission);
// 					w.Write(Members);
// 					w.Write(Funds);

					//LastConfirmedRound			= FindRound();

					for(int i = lcr.Id - lcr.Id % TailLength; i <= lcr.Id; i++)
					{
						var r = FindRound(i);

						Tail.Insert(0, r);
		
						r.Confirmed = false;
						Confirm(r, true);
					}

					//lcr.Time		= rd.ReadTime();
					//lcr.WeiSpent	= rd.ReadBigInteger();
					//lcr.Factor		= rd.ReadCoin();
					//lcr.Emission	= rd.ReadCoin();
					//Members			= rd.ReadList<Member>();
					//Funds			= rd.ReadList<Account>();

					//Members = LastConfirmedRound.Members;
					//Funds = LastConfirmedRound.Funds;
				}
			}
		}

		public void Add(Block b, bool execute = true)
		{
			var r = GetRound(b.RoundId);

			b.Round = r;

			r.Blocks.Add(b);
			r.Blocks = r.Blocks.OrderBy(i => i is Payload p ? p.OrderingKey : new byte[] {}, new BytesComparer()).ToList();
	
			if(b is Payload p)
			{
				foreach(var t in p.Transactions)
					foreach(var o in t.Operations)
						o.Placing = PlacingStage.Placed;

				//if(execute)
	 			//	for(int i = r.Id; i <= LastPayloadRound.Id; i++)
	 			//	{
	 			//		var ir = GetRound(i);
	 			//			
	 			//		if(ir.Payloads.Any() && ir.Previous != null)
				//		{
				//			ir.Time = CalculateTime(ir, ir.Unique);
				//			Execute(ir, ir.Payloads, null);
				//		}
	 			//		else
	 			//			break;
	 			//	}
			}
	
			if(r.FirstArrivalTime == DateTime.MaxValue)
			{
				r.FirstArrivalTime = DateTime.UtcNow;
			} 


// 			if(b is MembersJoinRequest jr)
// 			{
// 				//jr.Bail = Accounts.Find(jr.Generator, b.RoundId - Pitch).Bail;
// 				JoinRequests.Add(jr);
// 			}
	
			BlockAdded?.Invoke(b);
		}

		public void Add(IEnumerable<Block> bb)
		{
			foreach(var i in bb)
			{
				Add(i);
			}
		}

		public bool Verify(Block b)
		{
			if(LastConfirmedRound != null && b.RoundId <= LastConfirmedRound.Id)
				return false;

			var r = FindRound(b.RoundId);
	
			if(r != null && r.Blocks.Any(i => i.Signature.SequenceEqual(b.Signature)))
				return false;

			//if(JoinRequests.Any(i => i.Signature.SequenceEqual(b.Signature)))
			//	return false;
		
			return b.Valid;
		}

		public Round GetRound(int rid)
		{
			var r = FindRound(rid);

			if(r == null)
			{	
				r = new Round(this) {Id = rid};
				//r.LastAccessed = DateTime.UtcNow;
				Tail.Add(r);
				Tail = Tail.OrderByDescending(i => i.Id).ToList();
			}

			return r;
		}

		public Round FindRound(int rid)
		{
			foreach(var i in Tail)
				if(i.Id == rid)
				{
					//i.LastAccessed = DateTime.UtcNow;
					return i;
				}

			if(LoadedRounds.ContainsKey(rid))
			{
				var r = LoadedRounds[rid];
				//r.LastAccessed = DateTime.UtcNow;
				return r;
			}

			var d = Engine.Get(BitConverter.GetBytes(rid), ChainFamily);

			if(d != null)
			{
				var r = new Round(this);
				r.Id			= rid; 
				r.Voted			= true; 
				r.Confirmed		= true;
				//r.LastAccessed	= DateTime.UtcNow;

				r.Load(new BinaryReader(new MemoryStream(d)));
	
				LoadedRounds[r.Id] = r;
				//Recycle();
				
				return r;
			}
			else
				return null;
		}

		void Recycle()
		{
			if(LoadedRounds.Count > TailLength * 10)
			{
				foreach(var i in LoadedRounds.OrderByDescending(i => i.Value.Id).Skip(TailLength * 10))
				{
					LoadedRounds.Remove(i.Key);
				}
			}
		}

		public IEnumerable<Member> VoterOf(Round r)
		{
			return FindRound(r.Id - Pitch - 1).Members/*.Where(i => i.JoinedAt < r.Id)*/;
		}

		public bool QuorumReached(Round r)
		{
			var members = VoterOf(r).Select(i => i.Generator);

			var n = r.Majority.Count(i => members.Contains(i.Generator));
			
			var q = members.Count() * 2 / 3;

			if(members.Count() * 2 % 3 != 0)
				q++;

			return q <= n;
		}

		public bool QuorumFailed(Round r)
		{
			var max = VoterOf(r).Select(i => i.Generator);

			return r.Unique.Count() >= Math.Max(1, max.Count() * 2/3) && r.Majority.Count() + (max.Count() - r.Unique.Count()) < Math.Max(1, max.Count() * 2/3);
		}

		public ChainTime CalculateTime(Round round, IEnumerable<Vote> votes)
		{
 			if(round.Id == 0)
 			{
 				return round.Time;
 			}

 			if(!votes.Any())
 			{
				return round.Previous.Time + new ChainTime(1);
			}

			///var t = 0L;
			///var n = 0;
			///
			///for(int i = Math.Max(0, round.Id - Pitch + 1); i <= round.Id; i++)
			///{
			///	var r = FindRound(i);
			///	t += r.Payloads.Sum(i => i.Time.Ticks);
			///	n += r.Payloads.Count();
			///}
			///
			///t /= n;

			votes = votes.OrderBy(i => i.Generator);

			return round.Previous.Time + new ChainTime(votes.Sum(i => i.TimeDelta)/votes.Count());
		}

		public IEnumerable<Transaction> CollectValidTransactions(IEnumerable<Transaction> txs, Round round)
		{
			//txs = txs.Where(i => round.Id <= i.RoundMax /*&& IsSequential(i, round.Id)*/);

			if(txs.Any())
			{
// 				var p = new Payload(this);
// 				p.Member	= Account.Zero;
// 				p.Time		= DateTime.UtcNow;
// 				p.Round		= round;
// 				p.TimeDelta	= 1;
// 					
// 				foreach(var i in txs)
// 				{
// 					p.AddNext(i);
// 				}
// 				
//  				Execute(round, new Payload[] {p}, null);
 	
 //				txs = txs.Where(t => t.SuccessfulOperations.Any());
			}

			return txs;
		}

		///public bool IsSequential(Operation transaction, int ridmax)
		///{
		///	var prev = Accounts.FindLastOperation(transaction.Signer, o => o.Successful, t => t.Successful, null, r => r.Id < ridmax);
		///
		///	if(transaction.Id == 0 && prev == null)
		///		return true;
		///
		///	if(transaction.Id == 0 && prev != null || transaction.Id != 0 && prev != null && prev.Id != transaction.Id - 1)
		///		return false;
		///
		///	/// STRICT: return prev != null && (prev.Payload.Confirmed || prev.Payload.Transactions.All(i => IsSequential(i, i.Payload.RoundId))); /// All transactions in a block containing 'prev' one must also be sequential
		///	return prev.Transaction.Payload.Confirmed || IsSequential(prev, prev.Transaction.Payload.RoundId);
		///}

		public IEnumerable<Account> ProposeJoiners(Round round)
		{
			var o = round.Parent.JoinRequests.Select(jr =>	{
																var a = Accounts.Find(jr.Generator, LastConfirmedRound.Id);
																return new {jr = jr, a = a};
															})	/// round.ParentId - Pitch means to not join earlier than [Pitch] after declaration, and not redeclare after a join is requested
											.Where(i => i.a != null && 
														i.a.CandidacyDeclarationRound <= round.Id - Pitch * 2 &&  /// 2 = declared, requested
														i.a.Bail >= (Settings.Dev != null && Settings.Dev.DisableBailMin ? 0 : BailMin))
											.OrderByDescending(i => i.a.Bail)
											.ThenBy(i => i.a.Account)
											.Select(i => i.jr);

			var n = Math.Min(MembersMax - VoterOf(round).Count(), o.Count());

			return o.Take(n).Select(i => i.Generator);
		}

		public IEnumerable<Account> ProposeLeavers(Round round, Account generator)
		{
			var joiners = ProposeJoiners(round);

			var leavers = VoterOf(round).Where(i =>	i.JoinedAt < round.ParentId &&
													Tail.Count(r =>	round.ParentId <= r.Id && r.Id < round.Id &&					/// in previous Pitch number of rounds
																	r.Votes.Any(b => b.Generator == i.Generator)) < Pitch * 2/3 &&	/// sent less than 2/3 of required blocks
													!Enumerable.Range(round.ParentId + 1, Pitch - 1).Select(i => FindRound(i)).Any(r => r.Votes.Any(v => v.Generator == generator && v.Leavers.Contains(i.Generator)))) /// not yet reported in prev [Pitch-1] rounds
										.Select(i => i.Generator);

			return leavers;
		}

		public Consensus ProposeConsensus(Round round)
		{
			//if(round.Id < Pitch)
			//	return RoundReference.Empty;

			if(round.Id > LastGenesisRound && !round.Parent.Confirmed)
				return null;

			//if(!round.Payloads.Any())
			//	return null;

			var payloads = round.Majority.OfType<Payload>();

			round.Time = CalculateTime(round, payloads);
			Execute(round, payloads, round.Forkers);

			payloads = payloads.Where(i => i.SuccessfulTransactions.Any()).OrderBy(i => i.OrderingKey, new BytesComparer());
			//var nonempties = choice.Where(i => i.SuccessfulTransactions.Any());

			/// take only blocks with valid transactions or take first empty block 
			///var pp = (payloads);
			
			var rr = new Consensus();

			rr.Parent		= (round.Id >= Pitch ? round.Parent.Hash : Cryptography.ZeroHash);
			rr.Payloads		= payloads.					Select(i => i.Prefix).ToList();
			rr.Joiners		= round.ElectedJoiners.		Select(i => i.Prefix).OrderBy(i => i, new BytesComparer())/*.Take(rr.Leavers.Count + NewMembersPerRoundMax)*/.ToList();
			rr.Leavers		= round.ElectedLeavers.		Select(i => i.Prefix).OrderBy(i => i, new BytesComparer()).ToList();
			rr.Violators	= round.ElectedViolators.	Select(i => i.Prefix).OrderBy(i => i, new BytesComparer()).ToList();
			rr.FundLeavers	= round.ElectedFundLeavers.	Select(i => i.Prefix).OrderBy(i => i, new BytesComparer()).ToList();
			rr.FundJoiners	= round.ElectedFundJoiners.	Select(i => i.Prefix).OrderBy(i => i, new BytesComparer()).ToList();
			rr.Time			= CalculateTime(round, round.Unique);

			return rr; 
		}

		public void Execute(Round round, IEnumerable<Payload> payloads, IEnumerable<Account> forkers)
		{
			var prev = round.Previous;
				
			if(round.Id != 0 && prev == null)
				return;

			foreach(var b in payloads)
				foreach(var t in b.Transactions)
					foreach(var o in t.Operations)
					{
						//o.Successful = false;
						o.Error = null;
					}

			start: 

			round.Emission	= round.Id == 0 ? 0						: prev.Emission;
			round.WeiSpent	= round.Id == 0 ? 0						: prev.WeiSpent;
			round.Factor	= round.Id == 0 ? Emission.FactorStart	: prev.Factor;
			round.Members	= round.Id == 0 ? new()					: prev.Members.ToList();
			round.Funds		= round.Id == 0 ? new()					: prev.Funds.ToList();

			round.AffectedAccounts.Clear();
			round.AffectedAuthors.Clear();
			round.AffectedProducts.Clear();
			round.AffectedRealizations.Clear();
			round.AffectedReleases.Clear();

			foreach(var b in payloads.AsEnumerable().Reverse())
			{
				foreach(var t in b.Transactions.AsEnumerable().Reverse())
				{
					if(t.Operations.Any(i => i.Error != null))
						continue;

					Coin fee = 0;

					foreach(var o in t.Operations.AsEnumerable().Reverse())
					{
						//if(o.Error != null)
						//	continue;

						var s = round.AffectAccount(t.Signer);
					
						if(o.Id <= s.LastOperationId)
						{
							o.Error = Operation.NotSequential;
							goto start;
						}
						
						o.Execute(this, round);

						if(o.Error != null)
							goto start;

						var f = o.CalculateFee(round.Factor);
	
						if(s.Balance - f < 0)
						{
							o.Error = Operation.NotEnoughUNT;
							goto start;
						}

						fee += f;
						s.Balance -= f;
						s.LastOperationId = o.Id;
					}
						
					if(t.SuccessfulOperations.Count() == t.Operations.Count)
					{
						if(Settings.Database.Chain)
						{
							round.AffectAccount(t.Signer).Transactions.Add(round.Id);
						}

						round.Distribute(fee, new[]{b.Generator}, 9, round.Funds, 1); /// taking 10% we prevent a member from sending his own transactions using his own blocks for free, this could be used for block flooding
					}
				}
			}

			if(round.Id > LastGenesisRound)
			{
				var penalty = Coin.Zero;

				if(forkers != null && forkers.Any())
				{
					foreach(var f in forkers)
					{
						penalty += round.AffectAccount(f).Bail;
						round.AffectAccount(f).BailStatus = BailStatus.Siezed;
					}

					round.Distribute(penalty, round.Members.Where(i => !forkers.Contains(i.Generator)).Select(i => i.Generator), 1, round.Funds, 1);
				}
			}
		}

		public void Hashify()
		{
			BaseHash = Cryptography.Current.Hash(BaseState);
	
			foreach(var i in Accounts.SuperClusters.OrderBy(i => i.Key))		BaseHash = Cryptography.Current.Hash(Bytes.Xor(BaseHash, i.Value));
			foreach(var i in Authors.SuperClusters.OrderBy(i => i.Key))			BaseHash = Cryptography.Current.Hash(Bytes.Xor(BaseHash, i.Value));
			foreach(var i in Products.SuperClusters.OrderBy(i => i.Key))		BaseHash = Cryptography.Current.Hash(Bytes.Xor(BaseHash, i.Value));
			foreach(var i in Realizations.SuperClusters.OrderBy(i => i.Key))	BaseHash = Cryptography.Current.Hash(Bytes.Xor(BaseHash, i.Value));
			foreach(var i in Releases.SuperClusters.OrderBy(i => i.Key))		BaseHash = Cryptography.Current.Hash(Bytes.Xor(BaseHash, i.Value));
		}

		public void Confirm(Round round, bool confirmed)
		{
			if(round.Id > 0 && LastConfirmedRound != null && LastConfirmedRound.Id + 1 != round.Id)
				throw new IntegrityException("LastConfirmedRound.Id + 1 == round.Id");

			if(!confirmed)
			{
				List<T>	confirm<T>(IEnumerable<byte[]> prefixes, Func<Vote, IEnumerable<T>> get, Func<T, byte[]> getprefix)
				{
					var o = prefixes.Select(v => round.Unique.SelectMany(i => get(i)).FirstOrDefault(i => getprefix(i).SequenceEqual(v)));
	
					if(o.Contains(default(T)))
						throw new ConfirmationException("Can't confirm, some references not found", round);
					else 
						return o.ToList();
				}
	
				/// check we have all payload blocks 
	
				foreach(var i in round.Payloads)
					i.Confirmed = false;
	
				var child = FindRound(round.Id + Pitch);
				var c = child.Majority.First().Consensus;
	 	
 				foreach(var pf in c.Payloads)
 				{
 					var b = round.Unique.OfType<Payload>().FirstOrDefault(i => pf.SequenceEqual(i.Prefix));
 	
 					if(b != null)
 						b.Confirmed = true;
 					else
 						return;
 				}

				round.Time					= c.Time;
				round.ConfirmedPayloads		= round.Payloads.Where(i => i.Confirmed).OrderBy(i => i.OrderingKey, new BytesComparer()).ToList();
				round.ConfirmedJoiners		= confirm(c.Joiners,		i => i.Joiners,		i => i.Prefix).Select(i => new Member{Generator = i, IPs = round.Parent.JoinRequests.First(q => q.Generator == i).IPs}).ToList();
				round.ConfirmedLeavers		= confirm(c.Leavers,		i => i.Leavers,		i => i.Prefix);
				round.ConfirmedViolators	= confirm(c.Violators,		i => i.Violators,	i => i.Prefix);
				round.ConfirmedFundJoiners	= confirm(c.FundJoiners,	i => i.FundJoiners, i => i.Prefix);
				round.ConfirmedFundLeavers	= confirm(c.FundLeavers,	i => i.FundLeavers, i => i.Prefix);
			}
			else
				round.ConfirmedPayloads		= round.Payloads.ToList();

			Execute(round, round.ConfirmedPayloads, round.ConfirmedViolators);
			
			foreach(var b in round.Payloads)
			{
				foreach(var t in b.Transactions)
				{	
					foreach(var o in t.Operations)
					{	
						o.Placing = (b.Confirmed && o.Error == null) ? PlacingStage.Confirmed : PlacingStage.FailedOrNotFound;
#if DEBUG
						if(o.__ExpectedPlacing > PlacingStage.Placed && o.Placing != o.__ExpectedPlacing)
						{
							Debugger.Break();
						}
#endif
					}

					t.Operations.RemoveAll(i => i.Error != null);
				}

				b.Transactions.RemoveAll(t => !t.Operations.Any());
			}

			//round.Blocks.RemoveAll(b => b is Payload p && !p.Transactions.Any());

	 		//round.Members = round.Previous.Members.ToList();
			round.Members.AddRange(round.ConfirmedJoiners	.Where(i => Accounts.Find(i.Generator, round.Id).CandidacyDeclarationRound <= round.Id - Pitch * 2)
															.Select(i => new Member {Generator = i.Generator, IPs = i.IPs, JoinedAt = round.Id + Pitch}));
	
			round.Members.RemoveAll(i => round.AnyOperation(o => o is CandidacyDeclaration d && d.Signer == i.Generator && o.Placing == PlacingStage.Confirmed));  /// CandidacyDeclaration cancels membership
			round.Members.RemoveAll(i => round.AffectedAccounts.ContainsKey(i.Generator) && round.AffectedAccounts[i.Generator].Bail < (Settings.Dev.DisableBailMin ? 0 : BailMin));  /// if Bail has exhausted due to penalties (CURRENTY NOT APPLICABLE, penalties are disabled)
			round.Members.RemoveAll(i => round.ConfirmedLeavers.Contains(i.Generator));
			round.Members.RemoveAll(i => round.ConfirmedViolators.Contains(i.Generator));
	
			if(round.Id <= LastGenesisRound || round.Factor == Emission.FactorEnd) /// Funds reorganization only after emission is over
			{
				round.Funds.AddRange(round.ConfirmedFundJoiners);
				round.Funds.RemoveAll(i => round.ConfirmedFundLeavers.Contains(i));
			}

			using(var b = new WriteBatch())
			{
				if(Tail.Count(i => i.Id < round.Id) >= TailLength)
				{
					var tail = Tail.AsEnumerable().Reverse().Take(TailLength);
	
					foreach(var i in tail)
					{
						Accounts	.Save(b, i.AffectedAccounts.Values);
						Authors		.Save(b, i.AffectedAuthors.Values);
						Products	.Save(b, i.AffectedProducts.Values);
						Realizations.Save(b, i.AffectedRealizations.Values);
						Releases	.Save(b, i.AffectedReleases.Values);
					}

					LastCommittedRound = tail.Last();
	
					var s = new MemoryStream();
					var w = new BinaryWriter(s);
	
					w.Write7BitEncodedInt(LastCommittedRound.Id);
					w.Write(LastCommittedRound.Hash);
					w.Write(LastCommittedRound.Time);
					w.Write(LastCommittedRound.WeiSpent);
					w.Write(LastCommittedRound.Factor);
					w.Write(LastCommittedRound.Emission);
					w.Write(LastCommittedRound.Members.OrderBy(i => i.Generator));
					w.Write(LastCommittedRound.Funds.OrderBy(i => i));
	
					BaseState = s.ToArray();

					Hashify();
									
					b.Put(BaseStateKey, BaseState);
					b.Put(__BaseHashKey, BaseHash);

					foreach(var i in tail)
					{
						if(!LoadedRounds.ContainsKey(i.Id))
						{
							LoadedRounds.Add(i.Id, i);
						}
						
						Tail.Remove(i);
					}

					Recycle();
				}

				round.Hashify(round.Id > 0 ? round.Previous.Hash : Cryptography.ZeroHash); /// depends on BaseHash 

				if(Settings.Database.Chain)
				{
					var s = new MemoryStream();
					var w = new BinaryWriter(s);

					w.Write7BitEncodedInt(round.Id);

					b.Put(ChainStateKey, s.ToArray());

					s = new MemoryStream();
					w = new BinaryWriter(s);
	
					round.Save(w);
	
					b.Put(BitConverter.GetBytes(round.Id), s.ToArray(), ChainFamily);
				}

				Engine.Write(b);
			}

			if(round.Id > Pitch)
			{
				var cjr = FindRound(round.Id - Pitch - 1);
				
				if(cjr != null)
				{
					cjr.Blocks.RemoveAll(i => i is not Payload);
				}
			}

			//round.JoinRequests.RemoveAll(i => i.RoundId < round.Id - Pitch);
		
			round.Confirmed = true;
			LastConfirmedRound = round;
		}

		public ProductEntry FindProduct(ProductAddress product, int ridmax)
		{
			foreach(var r in Tail.Where(i => i.Id <= ridmax))
				if(r.AffectedProducts.ContainsKey(product))
					return r.AffectedProducts[product];

			var e = Products.FindEntry(product);

			if(e != null && (e.LastRegistration > ridmax))
				throw new IntegrityException("maxrid works inside pool only");

			return e;
		}

		public Transaction FindLastTailTransaction(Func<Transaction, bool> transaction_predicate, Func<Payload, bool> payload_predicate = null, Func<Round, bool> round_predicate = null)
		{
			foreach(var r in round_predicate == null ? Tail : Tail.Where(round_predicate))
				foreach(var b in payload_predicate == null ? r.Payloads : r.Payloads.Where(payload_predicate))
					foreach(var t in b.Transactions)
						if(transaction_predicate == null || transaction_predicate(t))
							return t;

			return null;
		}

		public IEnumerable<Transaction> FindLastTailTransactions(Func<Transaction, bool> transaction_predicate, Func<Payload, bool> payload_predicate = null, Func<Round, bool> round_predicate = null)
		{
			foreach(var r in round_predicate == null ? Tail : Tail.Where(round_predicate))
				foreach(var b in payload_predicate == null ? r.Payloads : r.Payloads.Where(payload_predicate))
					foreach(var t in transaction_predicate == null ? b.Transactions : b.Transactions.Where(transaction_predicate))
						yield return t;
		}

		public O FindLastTailOperation<O>(Func<O, bool> op = null, Func<Transaction, bool> tp = null, Func<Payload, bool> pp = null, Func<Round, bool> rp = null)
		{
			var ops = FindLastTailTransactions(tp, pp, rp).SelectMany(i => i.Operations.OfType<O>());
			return op == null ? ops.FirstOrDefault() : ops.FirstOrDefault(op);
		}

		IEnumerable<O> FindLastTailOperations<O>(Func<O, bool> op = null, Func<Transaction, bool> tp = null, Func<Payload, bool> pp = null, Func<Round, bool> rp = null)
		{
			var ops = FindLastTailTransactions(tp, pp, rp).SelectMany(i => i.Operations.OfType<O>());
			return op == null ? ops : ops.Where(op);
		}

		public Block FindLastBlock(Func<Block, bool> f, int maxrid = int.MaxValue)
		{
			for(int i = LastNonEmptyRound.Id; i >= maxrid; i--)
			{
				var r = FindRound(i);

				if(r != null)
				{
					foreach(var b in r.Blocks)
						if(f(b))
							return b;
				}
			}
			//foreach(var r in Rounds.Where(i => i.Id <= maxrid))
			//	foreach(var b in r.Blocks)
			//		if(f(b))
			//			return b;

			return null;
		}

		public IEnumerable<Block> FindLastBlocks(Func<Block, bool> f, int maxrid = int.MaxValue)
		{
			foreach(var r in Tail.Where(i => i.Id <= maxrid))
				foreach(var b in r.Blocks)
					if(f(b))
						yield return b;
		}

		public IEnumerable<ReleaseRegistration> FindReleases(string author, string product, Func<ReleaseRegistration, bool> f, int maxrid = int.MaxValue)
		{
			var p = FindProduct(new ProductAddress(author, product), maxrid);

			if(p == null)
				yield break;

			foreach(var r in p.Releases.Where(i => i.Rid <= maxrid).Select(i => FindRound(i.Rid).FindOperation<ReleaseRegistration>(o => o.Release.Author == author && o.Release.Product == product && o.Release.Version == i.Version)))
				yield return r;
		}
		
		public AccountInfo GetAccountInfo(Account account, bool confirmed)
		{
			var rmax = confirmed ? LastConfirmedRound : LastNonEmptyRound;

			var a = Accounts.Find(account, rmax.Id);

			if(a != null)
			{
				var i = new AccountInfo();


				i.Balance			= a.Balance;
				i.LastOperationId	= a.LastOperationId;
				//i.Authors			= a.Authors;

				if(Settings.Database.Chain)
				{
					//var t = Accounts.FindLastOperation(account, i => i.Successful, null, null, r => r.Id <= rmax.Id);

					//i.Operations = Accounts.FindLastOperations<Operation>(account, null, null, null, r => r.Id <= rmax.Id).Take(10).Reverse().Select(i => new AccountOperationInfo(i)).ToList();
				}

				return i;
			}

			return null;
		}

		public XonDocument GetAuthorInfo(string author, bool confirmed, IXonValueSerializator serializator)
		{
			var roundmax = confirmed ? LastConfirmedRound : LastNonEmptyRound;

			var a = Authors.Find(author, roundmax.Id);

			if(a != null)
			{
				return a.ToXon(serializator);
			}

			return null;
		}
				
		public QueryReleaseResult QueryRelease(ReleaseQuery query, bool confirmed)
		{
			if(query.VersionQuery == VersionQuery.Latest)
			{
				var roundmax = confirmed ? LastConfirmedRound : LastPayloadRound;
	
				var p = Products.Find(query.Realization, roundmax.Id);
	
				if(p != null)
				{
					var r = p.Releases.Where(i => i.Platform == query.Platform && i.Channel == query.Channel).MaxBy(i => i.Version);
					
					if(r != null)
					{
						var rr = FindRound(r.Rid).FindOperation<ReleaseRegistration>(m =>	(RealizationAddress)m.Release == (RealizationAddress)query.Realization && 
																							m.Release.Version == r.Version);
	
						return new QueryReleaseResult{Registration = rr};
					}
				}

				return null;
			}

			if(query.VersionQuery == VersionQuery.Exact)
			{
				var roundmax = confirmed ? LastConfirmedRound : LastPayloadRound;
	
				var p = Products.Find(query.Realization, roundmax.Id);
	
				if(p != null)
				{
					var r = p.Releases.Find(i => i.Platform == query.Platform && i.Version == query.Version);
					
					if(r != null)
					{
						var rr = FindRound(r.Rid).FindOperation<ReleaseRegistration>(m =>	(RealizationAddress)m.Release == (RealizationAddress)query.Realization && 
																							m.Release.Version == r.Version);
	
						return new QueryReleaseResult{Registration = rr};
					}
				}

				return null;
			}

			throw new ArgumentException("Unsupported VersionQuery");
		}
	}
}
